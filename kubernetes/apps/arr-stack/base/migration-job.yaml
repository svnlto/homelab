---
apiVersion: batch/v1
kind: Job
metadata:
  name: arr-migrate-config
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: arr-migrate-config
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: busybox:1.37
          command:
            - sh
            - -c
            - |
              set -eu

              echo "Starting arr-stack config migration..."

              for app in gluetun qbittorrent sabnzbd slskd prowlarr radarr sonarr lidarr bazarr recyclarr buildarr glance; do
                src="/source/$app"
                dst="/dest/$app"
                if [ -d "$src" ] && [ "$(ls -A "$src" 2>/dev/null)" ]; then
                  echo "Migrating $app..."
                  cp -a "$src/." "$dst/"
                  echo "  Done ($app)"
                else
                  echo "  Skipping $app (no source data)"
                fi
              done

              echo "Migration complete!"
          volumeMounts:
            # Source: NFS arr-config share
            - name: source
              mountPath: /source
              readOnly: true
            # Destinations: each app's config PVC
            - name: gluetun-config
              mountPath: /dest/gluetun
            - name: qbittorrent-config
              mountPath: /dest/qbittorrent
            - name: sabnzbd-config
              mountPath: /dest/sabnzbd
            - name: slskd-config
              mountPath: /dest/slskd
            - name: prowlarr-config
              mountPath: /dest/prowlarr
            - name: radarr-config
              mountPath: /dest/radarr
            - name: sonarr-config
              mountPath: /dest/sonarr
            - name: lidarr-config
              mountPath: /dest/lidarr
            - name: bazarr-config
              mountPath: /dest/bazarr
            - name: recyclarr-config
              mountPath: /dest/recyclarr
            - name: buildarr-config
              mountPath: /dest/buildarr
            - name: glance-config
              mountPath: /dest/glance
      volumes:
        - name: source
          persistentVolumeClaim:
            claimName: migration-source
        - name: gluetun-config
          persistentVolumeClaim:
            claimName: gluetun-config
        - name: qbittorrent-config
          persistentVolumeClaim:
            claimName: qbittorrent-config
        - name: sabnzbd-config
          persistentVolumeClaim:
            claimName: sabnzbd-config
        - name: slskd-config
          persistentVolumeClaim:
            claimName: slskd-config
        - name: prowlarr-config
          persistentVolumeClaim:
            claimName: prowlarr-config
        - name: radarr-config
          persistentVolumeClaim:
            claimName: radarr-config
        - name: sonarr-config
          persistentVolumeClaim:
            claimName: sonarr-config
        - name: lidarr-config
          persistentVolumeClaim:
            claimName: lidarr-config
        - name: bazarr-config
          persistentVolumeClaim:
            claimName: bazarr-config
        - name: recyclarr-config
          persistentVolumeClaim:
            claimName: recyclarr-config
        - name: buildarr-config
          persistentVolumeClaim:
            claimName: buildarr-config
        - name: glance-config
          persistentVolumeClaim:
            claimName: glance-config
