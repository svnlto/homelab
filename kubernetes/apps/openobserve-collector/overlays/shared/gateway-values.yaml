---
# OTel Collector Gateway (Deployment)
# Collects cluster-level metrics and K8s events (single replica).
# Exports to OpenObserve via OTLP HTTP.

image:
  repository: otel/opentelemetry-collector-contrib

mode: deployment

replicaCount: 1

presets:
  clusterMetrics:
    enabled: true
  kubernetesEvents:
    enabled: true
  kubernetesAttributes:
    enabled: true

extraEnvsFrom:
  - secretRef:
      name: openobserve-auth

resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    memory: 256Mi

config:
  processors:
    filter/metrics:
      metrics:
        exclude:
          match_type: regexp
          metric_names:
            - otelcol_.*
            - scrape_.*
            - promhttp_.*
            - up
    resource/cluster:
      attributes:
        - key: k8s_cluster_name
          value: k8s-shared
          action: upsert
        - key: k8s_cluster
          value: k8s-shared
          action: upsert
  exporters:
    otlphttp/openobserve:
      endpoint: http://openobserve-openobserve-standalone.openobserve.svc:5080/api/default/
      headers:
        Authorization: "${env:OPENOBSERVE_AUTH_HEADER}"
  service:
    pipelines:
      logs:
        processors:
          - resource/cluster
        exporters:
          - otlphttp/openobserve
      metrics:
        processors:
          - filter/metrics
          - resource/cluster
        exporters:
          - otlphttp/openobserve
