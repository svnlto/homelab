---
# =============================================================================
# Playbook: Configure Proxmox Nodes
# =============================================================================
# Run this playbook AFTER deploying nodes from the Packer image.
# It handles node-specific configuration, clustering, and ongoing management.
# =============================================================================
#
# Usage examples:
#   # Configure all nodes
#   ansible-playbook playbooks/configure-nodes.yml
#
#   # Configure specific node
#   ansible-playbook playbooks/configure-nodes.yml -l pve-node1
#
#   # Only run network configuration
#   ansible-playbook playbooks/configure-nodes.yml --tags network
#
#   # Setup clustering
#   ansible-playbook playbooks/configure-nodes.yml --tags cluster
#
# =============================================================================

- name: Configure Proxmox VE Nodes
  hosts: proxmox
  become: true
  gather_facts: true

  vars_prompt:
    - name: confirm_production
      prompt: "This will configure production nodes. Type 'yes' to continue"
      private: false
      default: "no"

  pre_tasks:
    - name: Confirm production deployment
      ansible.builtin.fail:
        msg: "Deployment cancelled. Please confirm with 'yes'."
      when: confirm_production != "yes"
      tags: [always]

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: apt
      tags: [always]

    - name: Verify Proxmox VE is installed
      ansible.builtin.assert:
        that:
          - "'proxmox-ve' in ansible_facts.packages"
        fail_msg: "Proxmox VE is not installed on this node!"
      tags: [always]

  tasks:
    - name: Configure SSH security
      ansible.builtin.include_role:
        name: security
      tags: [security]

    - name: Configure network
      ansible.builtin.include_role:
        name: network
      tags: [network]
      when: configure_network | default(false)

    - name: Configure storage
      ansible.builtin.include_role:
        name: storage
      tags: [storage]
      when: pve_storages is defined

    - name: Configure users and ACLs
      ansible.builtin.include_role:
        name: users
      tags: [users]
      when: pve_users is defined or pve_groups is defined

    - name: Configure clustering
      ansible.builtin.include_role:
        name: lae.proxmox
      tags: [cluster]
      when: pve_cluster_enabled | default(false)

  post_tasks:
    - name: Display node information
      ansible.builtin.debug:
        msg:
          - "Node: {{ inventory_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "Web UI: https://{{ ansible_default_ipv4.address }}:8006"
      tags: [always]
