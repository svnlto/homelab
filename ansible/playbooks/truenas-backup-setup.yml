---
# Configure TrueNAS SCALE on grogu as a replication target.
# Requires backup pool created manually before running.

- name: Configure TrueNAS SCALE on grogu (backup)
  hosts: truenas_secondary
  become: true

  environment:
    middleware_method: client

  tasks:
    - name: Check if backup pool exists
      ansible.builtin.command:
        cmd: midclt call pool.query '[["name", "=", "backup"]]'
      register: backup_pool_check
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Fail if backup pool does not exist
      ansible.builtin.fail:
        msg: "Backup pool 'backup' must be created manually before running this playbook"
      when: backup_pool_check.stdout | from_json | length == 0
      tags: [verify]

    # Datasets
    - name: Create backup datasets for replication
      arensb.truenas.filesystem:
        name: "backup/{{ item }}"
        state: present
        compression: "LZ4"
      loop:
        - media
        - photos
        - kubernetes
        - vms
        - ml-models
        - backups
      tags: [datasets]

    - name: Set backup datasets as read-only (will be overridden by replication)
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'backup/{{ item }}'
          '{"readonly": "ON"}'
      loop:
        - media
        - photos
        - kubernetes
        - vms
        - ml-models
        - backups
      register: readonly_result
      changed_when: false
      failed_when: false
      tags: [datasets, properties]

    # SSH for receiving replication
    - name: Ensure SSH service is enabled and running
      arensb.truenas.service:
        name: ssh
        state: started
        enabled: true
      tags: [ssh]

    - name: Configure SSH to allow root login (required for replication)
      ansible.builtin.command:
        cmd: >
          midclt call system.general.update '{
            "ui_allowlist": ["0.0.0.0/0"]
          }'
      changed_when: false
      failed_when: false
      tags: [ssh]

    - name: Display SSH key setup instructions
      ansible.builtin.debug:
        msg: |
          SSH setup for replication:
          1. On din: ssh-keygen -t ed25519 -f /root/.ssh/id_replication -N ""
          2. Copy to grogu: ssh-copy-id -i /root/.ssh/id_replication.pub root@192.168.0.14
          3. Test: ssh -i /root/.ssh/id_replication root@192.168.0.14
          4. Configure replication: just truenas-replication
      tags: [ssh, info]

    # Snapshot tasks
    - name: Create snapshot task for backup/kubernetes (daily, keep 7)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "backup/kubernetes",
            "recursive": true,
            "lifetime_value": 7,
            "lifetime_unit": "DAY",
            "naming_schema": "backup-%Y-%m-%d",
            "schedule": {
              "minute": "30",
              "hour": "2",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_k8s_backup
      changed_when: "'id' in snapshot_k8s_backup.stdout"
      failed_when: false
      tags: [snapshots]

    - name: Create snapshot task for backup/vms (daily, keep 7)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "backup/vms",
            "recursive": true,
            "lifetime_value": 7,
            "lifetime_unit": "DAY",
            "naming_schema": "backup-%Y-%m-%d",
            "schedule": {
              "minute": "30",
              "hour": "3",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_vms_backup
      changed_when: "'id' in snapshot_vms_backup.stdout"
      failed_when: false
      tags: [snapshots]

    - name: Create snapshot task for backup/ml-models (weekly, keep 4)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "backup/ml-models",
            "recursive": true,
            "lifetime_value": 4,
            "lifetime_unit": "WEEK",
            "naming_schema": "backup-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "5",
              "dom": "*",
              "month": "*",
              "dow": "sun"
            },
            "enabled": true
          }'
      register: snapshot_ml_backup
      changed_when: "'id' in snapshot_ml_backup.stdout"
      failed_when: false
      tags: [snapshots]

    - name: Create snapshot task for backup/media (weekly, keep 4)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "backup/media",
            "recursive": true,
            "lifetime_value": 4,
            "lifetime_unit": "WEEK",
            "naming_schema": "backup-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "4",
              "dom": "*",
              "month": "*",
              "dow": "sun"
            },
            "enabled": true
          }'
      register: snapshot_media_backup
      changed_when: "'id' in snapshot_media_backup.stdout"
      failed_when: false
      tags: [snapshots]

    # Scrub
    - name: Configure weekly scrub for backup pool
      arensb.truenas.pool_scrub_task:
        pool: backup
        threshold: 35
        description: "Weekly scrub - backup"
        minute: "0"
        hour: "1"
        day: "*"
        month: "*"
        weekday: "mon"
        enabled: true
      tags: [scrub]
      failed_when: false

    # Verification
    - name: Query backup datasets
      ansible.builtin.command:
        cmd: midclt call pool.dataset.query '[["id", "^", "backup/"]]'
      register: backup_datasets
      changed_when: false
      tags: [verify]

    - name: Display backup configuration summary
      ansible.builtin.debug:
        msg: |
          Datasets created:
          {% for dataset in (backup_datasets.stdout | from_json) %}
            - {{ dataset.name }}
          {% endfor %}

          Next steps:
          1. Configure SSH key on din (primary TrueNAS)
          2. Run: just truenas-replication
      tags: [verify, info]
