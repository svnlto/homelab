---
# Initial TrueNAS SCALE configuration after ISO install.
# Run with --ask-pass for initial password authentication.
# After this playbook, SSH keys will be configured for passwordless access.

- name: Initial TrueNAS SCALE Configuration
  hosts: truenas_primary,truenas_secondary
  gather_facts: true

  vars:
    truenas_timezone: "Europe/Berlin"
    ntp_servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org

  tasks:
    # System info
    - name: Get TrueNAS system information
      ansible.builtin.command:
        cmd: midclt call system.info
      register: system_info
      changed_when: false
      tags: [info]

    - name: Display TrueNAS version
      ansible.builtin.debug:
        msg: |
          Hostname: {{ (system_info.stdout | from_json).hostname }}
          Version: {{ (system_info.stdout | from_json).version }}
          Uptime: {{ (system_info.stdout | from_json).uptime_seconds | int // 3600 }} hours
      when: system_info.stdout is defined and system_info.stdout | length > 0
      tags: [info]

    # SSH
    - name: Enable SSH service
      arensb.truenas.service:
        name: ssh
        state: started
        enabled: true
      tags: [ssh]

    - name: Update SSH configuration (ensure password auth enabled)
      ansible.builtin.command:
        cmd: >
          midclt call ssh.update '{
            "passwordauth": true,
            "tcpport": 22
          }'
      register: ssh_update
      changed_when: true
      failed_when: false
      tags: [ssh]

    # SSH key authentication
    - name: Read SSH public key from 1Password
      ansible.builtin.command:
        cmd: op read "op://Personal/proxmox/public key"
      register: local_ssh_key
      delegate_to: localhost
      become: false
      changed_when: false
      tags: [ssh, keys]

    - name: Get current user information
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "{{ ansible_user }}"]]'
      register: user_info
      changed_when: false
      tags: [ssh, keys]

    - name: Check if SSH key already exists
      ansible.builtin.set_fact:
        existing_key: "{{ (user_info.stdout | from_json)[0].sshpubkey | default('') }}"
        user_id: "{{ (user_info.stdout | from_json)[0].id }}"
      when: user_info.stdout is defined and user_info.stdout | length > 0
      tags: [ssh, keys]

    - name: Add SSH public key to user account
      ansible.builtin.command:
        cmd: >
          midclt call user.update
          {{ user_id }}
          '{"sshpubkey": "{{ local_ssh_key.stdout | trim }}"}'
      register: ssh_key_result
      changed_when: true
      when:
        - user_info.stdout is defined
        - user_info.stdout | length > 0
        - (existing_key is none or existing_key == '' or local_ssh_key.stdout | trim not in existing_key)
      tags: [ssh, keys]

    # Timezone and NTP
    - name: Configure timezone
      ansible.builtin.command:
        cmd: >
          midclt call system.general.update '{
            "timezone": "{{ truenas_timezone }}"
          }'
      register: timezone_result
      changed_when: false
      tags: [timezone]

    - name: Configure NTP servers
      ansible.builtin.command:
        cmd: >
          midclt call system.ntpserver.create '{
            "address": "{{ item }}",
            "burst": false,
            "iburst": true,
            "prefer": false,
            "minpoll": 6,
            "maxpoll": 10
          }'
      loop: "{{ ntp_servers }}"
      register: ntp_result
      changed_when: "'id' in ntp_result.stdout"
      failed_when: false
      tags: [ntp]

    # Network verification
    - name: Get network configuration
      ansible.builtin.command:
        cmd: midclt call interface.query
      register: network_config
      changed_when: false
      tags: [network, verify]

    - name: Test internet connectivity
      ansible.builtin.command:
        cmd: ping -c 3 8.8.8.8
      register: ping_result
      changed_when: false
      failed_when: false
      tags: [network, verify]

    # System tuning
    - name: Set system tunables for ZFS
      ansible.builtin.command:
        cmd: >
          midclt call tunable.create '{
            "var": "{{ item.var }}",
            "value": "{{ item.value }}",
            "type": "SYSCTL",
            "comment": "{{ item.comment }}",
            "enabled": true
          }'
      loop:
        - var: vfs.zfs.arc.max
          value: "17179869184"
          comment: "Limit ZFS ARC to 16GB"
      register: tunable_result
      changed_when: "'id' in tunable_result.stdout"
      failed_when: false
      tags: [tuning]

    - name: Display setup summary
      ansible.builtin.debug:
        msg: |
          Initial setup complete for {{ ansible_host }}.

          Next steps:
          1. Install Scrutiny app via TrueNAS WebUI (Apps > Discover)
          2. Create ZFS pools manually via midclt
          3. Run: ansible-playbook playbooks/truenas-setup.yml
      tags: [info, summary]
