---
# Configure TrueNAS SCALE primary storage (din).
# Pools must be created manually via midclt before running this.

- name: Configure TrueNAS SCALE on din (primary)
  hosts: truenas_primary
  become: true

  vars_files:
    - ../vars/datasets.yml
    - ../vars/snapshots.yml
    - ../vars/shares.yml

  environment:
    middleware_method: client

  handlers:
    - name: Commit network changes
      ansible.builtin.command:
        cmd: midclt call interface.commit
      changed_when: true
      notify: Checkin network changes
      tags: [network]

    - name: Checkin network changes
      ansible.builtin.command:
        cmd: midclt call interface.checkin
      changed_when: false
      tags: [network]

  tasks:
    # Network
    - name: Configure storage VLAN interface (enp6s19)
      ansible.builtin.command:
        cmd: >
          midclt call interface.update enp6s19 '{"aliases": [{"type": "INET", "address": "10.10.10.13", "netmask": 24}]}'
      register: storage_iface
      changed_when: "'enp6s19' in storage_iface.stdout"
      failed_when: "storage_iface.rc != 0 and 'does not exist' not in storage_iface.stderr"
      notify: Commit network changes
      tags: [network]

    # Bulk pool datasets
    - name: Create bulk kubernetes parent dataset
      arensb.truenas.filesystem:
        name: "bulk/kubernetes"
        state: present
        compression: "LZ4"
      tags: [datasets, bulk, k8s]

    - name: Create bulk kubernetes NFS dynamic dataset
      arensb.truenas.filesystem:
        name: "bulk/kubernetes/nfs-dynamic"
        state: present
        compression: "LZ4"
      tags: [datasets, bulk, k8s]

    - name: Create bulk media parent dataset
      arensb.truenas.filesystem:
        name: "bulk/media"
        state: present
        compression: "LZ4"
        atime: "OFF"
      tags: [datasets, bulk]

    - name: Set ownership on bulk media dataset root
      ansible.builtin.command:
        cmd: >
          midclt call filesystem.setperm '{
            "path": "/mnt/bulk/media",
            "uid": 1000,
            "gid": 1000,
            "mode": "0775",
            "options": {"recursive": false, "traverse": false}
          }'
      changed_when: false
      failed_when: false
      tags: [datasets, bulk]

    - name: Create bulk media subdirectories
      ansible.builtin.command:
        cmd: >
          midclt call filesystem.mkdir '"/mnt/bulk/media/{{ item }}"'
      loop:
        - music
        - movies
        - tv
        - books
        - downloads
        - downloads/torrents
        - downloads/usenet
        - downloads/soulseek
      register: media_dirs
      changed_when: media_dirs.rc == 0
      failed_when: false
      tags: [datasets, bulk]

    - name: Set ownership on bulk media subdirectories
      ansible.builtin.command:
        cmd: >
          midclt call filesystem.setperm '{
            "path": "/mnt/bulk/media/{{ item }}",
            "uid": 1000,
            "gid": 1000,
            "mode": "0775",
            "options": {"recursive": true, "traverse": false}
          }'
      loop:
        - music
        - movies
        - tv
        - books
        - downloads
        - downloads/torrents
        - downloads/usenet
        - downloads/soulseek
      changed_when: false
      failed_when: false
      tags: [datasets, bulk, fix-perms]

    - name: Create bulk photos dataset (Immich)
      arensb.truenas.filesystem:
        name: "bulk/photos"
        state: present
        compression: "LZ4"
        atime: "OFF"
      tags: [datasets, bulk, photos]

    - name: Create bulk signoz cold storage dataset
      arensb.truenas.filesystem:
        name: "bulk/signoz-cold"
        state: present
        compression: "ZSTD"
      tags: [datasets, bulk, observability]

    - name: Create bulk backups parent dataset
      arensb.truenas.filesystem:
        name: "bulk/backups"
        state: present
        compression: "ZSTD"
      tags: [datasets, bulk, backups]

    - name: Create bulk backup datasets
      arensb.truenas.filesystem:
        name: "bulk/backups/{{ item }}"
        state: present
        compression: "ZSTD"
      loop:
        - proxmox
        - restic-repo
        - forgejo
      tags: [datasets, bulk, backups]

    - name: Create bulk/backups/timemachine dataset (case-insensitive for macOS)
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.create '{
            "name": "bulk/backups/timemachine",
            "compression": "ZSTD",
            "casesensitivity": "INSENSITIVE",
            "acltype": "NFSV4",
            "aclmode": "PASSTHROUGH"
          }'
      register: tm_dataset_create
      changed_when: tm_dataset_create.rc == 0
      failed_when: >
        tm_dataset_create.rc != 0
        and 'already exists' not in (tm_dataset_create.stderr | default(''))
        and 'already exists' not in (tm_dataset_create.stdout | default(''))
      tags: [datasets, bulk, backups, timemachine]

    - name: Create bulk arr-config dataset
      arensb.truenas.filesystem:
        name: "bulk/arr-config"
        state: present
        compression: "LZ4"
        atime: "OFF"
      tags: [datasets, bulk, arr]
      # TODO: Move to fast/arr-config once MD1220 hardware arrives

    - name: Create bulk archive dataset
      arensb.truenas.filesystem:
        name: "bulk/archive"
        state: present
        compression: "LZ4"
      tags: [datasets, bulk]

    # Fast pool datasets
    - name: Create fast kubernetes parent dataset
      arensb.truenas.filesystem:
        name: "fast/kubernetes"
        state: present
        compression: "LZ4"
      tags: [datasets, fast, k8s]

    - name: Create fast kubernetes NFS datasets
      arensb.truenas.filesystem:
        name: "fast/kubernetes/{{ item }}"
        state: present
        compression: "LZ4"
      loop:
        - nfs-dynamic
        - nfs-static
      tags: [datasets, fast, k8s]

    - name: Create fast kubernetes iSCSI parent dataset
      arensb.truenas.filesystem:
        name: "fast/kubernetes/iscsi-zvols"
        state: present
        compression: "LZ4"
      tags: [datasets, fast, k8s, iscsi]

    - name: Create fast VMs dataset
      arensb.truenas.filesystem:
        name: "fast/vms"
        state: present
        compression: "LZ4"
      tags: [datasets, fast, vms]

    - name: Create fast ML models dataset
      arensb.truenas.filesystem:
        name: "fast/ml-models"
        state: present
        compression: "LZ4"
      tags: [datasets, fast, ml]

    # Scratch pool datasets
    - name: Create scratch kubernetes parent dataset
      arensb.truenas.filesystem:
        name: "scratch/kubernetes"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      tags: [datasets, scratch, k8s]

    - name: Create scratch kubernetes NFS dynamic dataset
      arensb.truenas.filesystem:
        name: "scratch/kubernetes/nfs-dynamic"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      tags: [datasets, scratch, k8s]

    - name: Create scratch downloads parent dataset
      arensb.truenas.filesystem:
        name: "scratch/downloads"
        state: present
        compression: "OFF"
        sync: "DISABLED"
      tags: [datasets, scratch, downloads]

    - name: Create scratch downloads incomplete dataset
      arensb.truenas.filesystem:
        name: "scratch/downloads/incomplete"
        state: present
        compression: "OFF"
        sync: "DISABLED"
      tags: [datasets, scratch, downloads]

    - name: Set ownership on scratch/downloads/incomplete (media:media)
      ansible.builtin.command:
        cmd: >
          midclt call filesystem.setperm '{
            "path": "/mnt/scratch/downloads/incomplete",
            "uid": 1000,
            "gid": 1000,
            "mode": "0775",
            "options": {"recursive": false, "traverse": false}
          }'
      changed_when: false
      failed_when: false
      tags: [datasets, scratch, downloads]

    - name: Create scratch CI runners parent dataset
      arensb.truenas.filesystem:
        name: "scratch/ci-runners"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      tags: [datasets, scratch, ci]

    - name: Create scratch CI runners child datasets
      arensb.truenas.filesystem:
        name: "scratch/ci-runners/{{ item }}"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      loop:
        - cache
        - artifacts
      tags: [datasets, scratch, ci]

    - name: Create scratch ML datasets dataset
      arensb.truenas.filesystem:
        name: "scratch/ml-datasets"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      tags: [datasets, scratch, ml]

    - name: Create scratch immich-migration parent dataset
      arensb.truenas.filesystem:
        name: "scratch/immich-migration"
        state: present
        compression: "LZ4"
      tags: [datasets, scratch, dumper]

    - name: Create scratch immich-migration/dump dataset
      arensb.truenas.filesystem:
        name: "scratch/immich-migration/dump"
        state: present
        compression: "LZ4"
      tags: [datasets, scratch, dumper]

    - name: Create scratch temp dataset
      arensb.truenas.filesystem:
        name: "scratch/temp"
        state: present
        compression: "LZ4"
        sync: "DISABLED"
      tags: [datasets, scratch]

    # ZFS properties (via midclt â€” arensb.truenas doesn't support recordsize/sync/quotas)

    - name: Set bulk/kubernetes/nfs-dynamic properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/kubernetes/nfs-dynamic'
          '{"recordsize": "128K", "quota": 10995116277760}'
      changed_when: false
      tags: [properties, bulk, k8s]

    - name: Set bulk/media recordsize to 1M
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/media'
          '{"recordsize": "1M"}'
      changed_when: false
      tags: [properties, bulk]

    - name: Set bulk/photos recordsize to 1M
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/photos'
          '{"recordsize": "1M"}'
      changed_when: false
      tags: [properties, bulk, photos]

    - name: Set bulk/arr-config recordsize to 16K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/arr-config'
          '{"recordsize": "16K"}'
      changed_when: false
      tags: [properties, bulk, arr]

    - name: Set bulk/signoz-cold recordsize to 128K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/signoz-cold'
          '{"recordsize": "128K"}'
      changed_when: false
      tags: [properties, bulk, observability]

    - name: Set bulk/backups/timemachine properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/backups/timemachine'
          '{"quota": 2199023255552, "acltype": "NFSV4", "aclmode": "PASSTHROUGH"}'
      changed_when: false
      tags: [properties, bulk, backups, timemachine]

    - name: Set bulk/backups/forgejo quota (100GB)
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'bulk/backups/forgejo'
          '{"quota": 107374182400}'
      changed_when: false
      tags: [properties, bulk, backups, forgejo]

    - name: Set fast/kubernetes/nfs-dynamic properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'fast/kubernetes/nfs-dynamic'
          '{"recordsize": "16K", "quota": 4398046511104}'
      changed_when: false
      tags: [properties, fast, k8s]

    - name: Set fast/kubernetes/nfs-static recordsize to 128K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'fast/kubernetes/nfs-static'
          '{"recordsize": "128K"}'
      changed_when: false
      tags: [properties, fast, k8s]

    - name: Set fast/kubernetes/iscsi-zvols properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'fast/kubernetes/iscsi-zvols'
          '{"volblocksize": "16K", "compression": "LZ4", "sync": "STANDARD"}'
      changed_when: false
      failed_when: false
      tags: [properties, fast, k8s, iscsi]

    - name: Set fast/vms recordsize to 64K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'fast/vms'
          '{"recordsize": "64K"}'
      changed_when: false
      tags: [properties, fast, vms]

    - name: Set fast/ml-models properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'fast/ml-models'
          '{"recordsize": "1M", "quota": 1099511627776}'
      changed_when: false
      tags: [properties, fast, ml]

    - name: Set scratch/kubernetes/nfs-dynamic properties
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'scratch/kubernetes/nfs-dynamic'
          '{"recordsize": "128K", "quota": 8796093022208}'
      changed_when: false
      tags: [properties, scratch, k8s]

    - name: Set scratch/downloads/incomplete recordsize to 16K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'scratch/downloads/incomplete'
          '{"recordsize": "16K"}'
      changed_when: false
      tags: [properties, scratch, downloads]

    - name: Set scratch/ci-runners/cache recordsize to 128K
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'scratch/ci-runners/cache'
          '{"recordsize": "128K"}'
      changed_when: false
      tags: [properties, scratch, ci]

    - name: Set scratch/ml-datasets recordsize to 1M
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.update
          'scratch/ml-datasets'
          '{"recordsize": "1M"}'
      changed_when: false
      tags: [properties, scratch, ml]

    # NFS shares
    - name: Configure NFS service
      arensb.truenas.nfs:
        servers: 4
        protocols:
          - NFSV4
      tags: [nfs, services]

    - name: Enable NFS service
      arensb.truenas.service:
        name: nfs
        state: started
        enabled: true
      tags: [nfs, services]

    - name: Create NFS share for media and downloads
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/media
        comment: "Media + downloads for arr-stack (hardlinks)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares]

    - name: Create NFS share for media/movies (child dataset)
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/media/movies
        comment: "Movies library (child dataset)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares]

    - name: Create NFS share for media/tv (child dataset)
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/media/tv
        comment: "TV library (child dataset)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares]

    - name: Create NFS share for media/music (child dataset)
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/media/music
        comment: "Music library (child dataset)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares]

    - name: Create NFS share for media/books (child dataset)
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/media/books
        comment: "Books library (child dataset)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares]

    - name: Create NFS share for arr-config
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/arr-config
        comment: "Arr stack configuration data (databases, settings)"
        mapall_user: media
        mapall_group: media
        networks:
          - 192.168.0.0/24
        state: present
      tags: [nfs, shares, arr]

    - name: Create NFS share for photos (Immich)
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/photos
        comment: "Photos for Immich"
        mapall_user: immich
        mapall_group: immich
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
          - 10.0.1.0/24
        state: present
      tags: [nfs, shares, photos]

    - name: Create NFS share for kubernetes dynamic
      arensb.truenas.sharing_nfs:
        path: /mnt/fast/kubernetes/nfs-dynamic
        comment: "democratic-csi dynamic provisioning"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
        state: present
      tags: [nfs, shares, fast]

    - name: Create NFS share for kubernetes static
      arensb.truenas.sharing_nfs:
        path: /mnt/fast/kubernetes/nfs-static
        comment: "Static PVs for shared configs"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
          - 10.0.3.0/24
        state: present
      tags: [nfs, shares, k8s, fast]

    - name: Create NFS share for bulk kubernetes dynamic
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/kubernetes/nfs-dynamic
        comment: "democratic-csi bulk pool (Forgejo registry, large app data)"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
          - 10.0.3.0/24
        state: present
      tags: [nfs, shares, k8s, bulk]

    - name: Create NFS share for scratch kubernetes dynamic
      arensb.truenas.sharing_nfs:
        path: /mnt/scratch/kubernetes/nfs-dynamic
        comment: "democratic-csi scratch pool (CI cache, ephemeral data)"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
          - 10.0.3.0/24
        state: present
      tags: [nfs, shares, k8s, scratch]

    - name: Create NFS share for Signoz cold storage
      arensb.truenas.sharing_nfs:
        path: /mnt/bulk/signoz-cold
        comment: "Signoz cold storage (30+ days)"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
        state: present
      tags: [nfs, shares, observability]

    - name: Create NFS share for immich-migration dump (dumper VM)
      arensb.truenas.sharing_nfs:
        path: /mnt/scratch/immich-migration/dump
        comment: "Photo dump from remote machine via rsync (dumper VM)"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
        state: present
      tags: [nfs, shares, scratch, dumper]

    - name: Create NFS share for scratch downloads (incomplete)
      arensb.truenas.sharing_nfs:
        path: /mnt/scratch/downloads/incomplete
        comment: "Active/incomplete downloads (temp staging)"
        mapall_user: media
        mapall_group: media
        networks:
          - 10.10.10.0/24
          - 192.168.0.0/24
        state: present
      tags: [nfs, shares, downloads]

    - name: Create NFS share for CI runners
      arensb.truenas.sharing_nfs:
        path: /mnt/scratch/ci-runners
        comment: "Forgejo CI runner cache and artifacts"
        maproot_user: root
        maproot_group: wheel
        networks:
          - 10.10.10.0/24
          - 10.0.1.0/24
          - 10.0.2.0/24
        state: present
      tags: [nfs, shares, ci]

    # iSCSI
    - name: Configure iSCSI portal (Storage VLAN)
      ansible.builtin.command:
        cmd: >
          midclt call iscsi.portal.create '{
            "comment": "Storage VLAN Portal",
            "listen": [{"ip": "10.10.10.13", "port": 3260}]
          }'
      register: iscsi_portal
      changed_when: "'id' in iscsi_portal.stdout"
      failed_when: false
      tags: [iscsi]

    - name: Configure iSCSI initiator group (allow K8s nodes)
      ansible.builtin.command:
        cmd: >
          midclt call iscsi.initiator.create '{
            "comment": "Kubernetes Nodes",
            "initiators": [],
            "auth_network": ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
          }'
      register: iscsi_initiator
      changed_when: "'id' in iscsi_initiator.stdout"
      failed_when: false
      tags: [iscsi]

    - name: Enable iSCSI service
      arensb.truenas.service:
        name: iscsitarget
        state: started
        enabled: true
      tags: [iscsi, services]

    # SMB shares
    - name: Enable Apple SMB2/3 protocol extensions
      ansible.builtin.command:
        cmd: >
          midclt call smb.update '{
            "aapl_extensions": true
          }'
      register: smb_config
      changed_when: false
      failed_when: false
      tags: [smb, services]

    - name: Enable SMB service
      arensb.truenas.service:
        name: cifs
        state: started
        enabled: true
      tags: [smb, services]

    - name: Create Time Machine SMB share
      arensb.truenas.sharing_smb:
        name: TimeMachine
        path: /mnt/bulk/backups/timemachine
        purpose: ENHANCED_TIMEMACHINE
        comment: "macOS Time Machine backups"
        state: present
      tags: [smb, shares]

    - name: Create SMB shares from variable
      arensb.truenas.sharing_smb:
        name: "{{ item.name }}"
        path: "{{ item.path }}"
        purpose: "{{ item.purpose }}"
        comment: "{{ item.comment }}"
        state: present
      loop: "{{ smb_shares | rejectattr('name', 'equalto', 'TimeMachine') | list }}"
      loop_control:
        label: "{{ item.name }}"
      tags: [smb, shares]

    - name: Set permissions on Time Machine dataset
      ansible.builtin.command:
        cmd: >
          midclt call filesystem.setperm '{
            "path": "/mnt/bulk/backups/timemachine",
            "uid": 1002,
            "gid": 1002,
            "mode": "0770",
            "options": {"recursive": false, "traverse": false}
          }'
      register: timemachine_perms
      changed_when: false
      failed_when: false
      tags: [smb, bulk, backups]

    - name: Create Time Machine marker file
      ansible.builtin.command:
        cmd: touch /mnt/bulk/backups/timemachine/.com.apple.timemachine.supported
      changed_when: false
      failed_when: false
      tags: [smb, bulk, backups]

    - name: Set Time Machine quota (2TB)
      ansible.builtin.command:
        cmd: >
          midclt call sharing.smb.update 1 '{
            "timemachine_quota": 2048
          }'
      register: tm_quota
      changed_when: false
      failed_when: false
      tags: [smb, bulk, backups]

    # Users and groups
    - name: Create media group
      arensb.truenas.group:
        name: media
        gid: 1000
      tags: [users]

    - name: Create media user
      arensb.truenas.user:
        name: media
        uid: 1000
        group: media
        home: /var/empty
        shell: /usr/sbin/nologin
        comment: "Media Service Account"
        password: "*"
        smb: false
      tags: [users]

    - name: Create immich group
      arensb.truenas.group:
        name: immich
        gid: 1001
      tags: [users, photos]

    - name: Create immich user
      arensb.truenas.user:
        name: immich
        uid: 1001
        group: immich
        home: /var/empty
        shell: /usr/sbin/nologin
        comment: "Immich Service Account"
        password: "*"
        smb: false
      tags: [users, photos]

    - name: Create svenlito group for SMB access
      arensb.truenas.group:
        name: svenlito
        gid: 1002
      tags: [users, smb]

    - name: Create svenlito user for SMB/Time Machine
      arensb.truenas.user:
        name: svenlito
        uid: 1002
        group: svenlito
        home: /mnt/bulk/backups
        shell: /usr/bin/bash
        comment: "Sven Lito"
        password: "{{ lookup('env', 'TRUENAS_SMB_PASSWORD') | default('changeme123', true) }}"
        smb: true
      tags: [users, smb]

    - name: Get media group ID
      ansible.builtin.command:
        cmd: midclt call group.query '[["group", "=", "media"]]'
      register: media_group_info
      changed_when: false
      tags: [users]

    - name: Get truenas_admin user info
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "truenas_admin"]]'
      register: truenas_admin_info
      changed_when: false
      tags: [users]

    - name: Add truenas_admin to media group (preserving existing groups)
      ansible.builtin.command:
        cmd: >
          midclt call user.update
          {{ (truenas_admin_info.stdout | from_json)[0].id }}
          '{"groups": {{ (truenas_admin_info.stdout | from_json)[0].groups | union([(media_group_info.stdout | from_json)[0].id])
          | to_json }}}'
      when:
        - (media_group_info.stdout | from_json) | length > 0
        - (truenas_admin_info.stdout | from_json) | length > 0
        - (media_group_info.stdout | from_json)[0].id not in (truenas_admin_info.stdout | from_json)[0].groups
      changed_when: true
      tags: [users]

    # Snapshot tasks
    - name: Create snapshot task for fast/kubernetes (hourly, keep 24)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "fast/kubernetes",
            "recursive": true,
            "lifetime_value": 24,
            "lifetime_unit": "HOUR",
            "naming_schema": "auto-%Y-%m-%d_%H-%M",
            "schedule": {
              "minute": "0",
              "hour": "*",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_k8s
      changed_when: "'id' in snapshot_k8s.stdout"
      failed_when: false
      tags: [snapshots]

    - name: Create snapshot task for fast/vms (every 4 hours, keep 6)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "fast/vms",
            "recursive": true,
            "lifetime_value": 6,
            "lifetime_unit": "HOUR",
            "naming_schema": "auto-%Y-%m-%d_%H-%M",
            "schedule": {
              "minute": "0",
              "hour": "*/4",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_vms
      changed_when: "'id' in snapshot_vms.stdout"
      failed_when: false
      tags: [snapshots, vms]

    - name: Create snapshot task for fast/ml-models (daily, keep 7)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "fast/ml-models",
            "recursive": true,
            "lifetime_value": 7,
            "lifetime_unit": "DAY",
            "naming_schema": "daily-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "5",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_ml
      changed_when: "'id' in snapshot_ml.stdout"
      failed_when: false
      tags: [snapshots, ml]

    - name: Create snapshot task for bulk/media (daily, keep 7)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "bulk/media",
            "recursive": true,
            "lifetime_value": 7,
            "lifetime_unit": "DAY",
            "naming_schema": "daily-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "2",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_media
      changed_when: "'id' in snapshot_media.stdout"
      failed_when: false
      tags: [snapshots]

    - name: Create snapshot task for bulk/arr-config (daily, keep 14)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "bulk/arr-config",
            "recursive": true,
            "lifetime_value": 14,
            "lifetime_unit": "DAY",
            "naming_schema": "daily-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "4",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_arr
      changed_when: "'id' in snapshot_arr.stdout"
      failed_when: false
      tags: [snapshots, arr]

    - name: Create snapshot task for bulk/photos (daily, keep 30)
      ansible.builtin.command:
        cmd: >
          midclt call pool.snapshottask.create '{
            "dataset": "bulk/photos",
            "recursive": true,
            "lifetime_value": 30,
            "lifetime_unit": "DAY",
            "naming_schema": "daily-%Y-%m-%d",
            "schedule": {
              "minute": "0",
              "hour": "3",
              "dom": "*",
              "month": "*",
              "dow": "*"
            },
            "enabled": true
          }'
      register: snapshot_photos
      changed_when: "'id' in snapshot_photos.stdout"
      failed_when: false
      tags: [snapshots, photos]

    # Scrub tasks
    - name: Configure weekly scrub for bulk pool
      arensb.truenas.pool_scrub_task:
        pool: bulk
        threshold: 35
        description: "Weekly scrub - bulk"
        minute: "0"
        hour: "0"
        day: "*"
        month: "*"
        weekday: "sun"
        enabled: true
      tags: [scrub]
      failed_when: false

    - name: Configure weekly scrub for fast pool
      arensb.truenas.pool_scrub_task:
        pool: fast
        threshold: 35
        description: "Weekly scrub - fast"
        minute: "0"
        hour: "3"
        day: "*"
        month: "*"
        weekday: "sun"
        enabled: true
      tags: [scrub]
      failed_when: false

    - name: Configure weekly scrub for scratch pool
      arensb.truenas.pool_scrub_task:
        pool: scratch
        threshold: 35
        description: "Weekly scrub - scratch"
        minute: "0"
        hour: "6"
        day: "*"
        month: "*"
        weekday: "sun"
        enabled: true
      tags: [scrub]
      failed_when: false
