---
# Verify TrueNAS SCALE setup applied correctly.
# Run after truenas-setup.yml to validate expected state.

- name: Verify TrueNAS SCALE setup on din (primary)
  hosts: truenas_primary
  gather_facts: false

  vars_files:
    - ../vars/shares.yml

  tasks:
    # Datasets
    - name: Verify bulk pool datasets exist
      ansible.builtin.command:
        cmd: midclt call pool.dataset.query '[["id", "=", "{{ item }}"]]'
      register: bulk_datasets
      changed_when: false
      failed_when: "'[]' == bulk_datasets.stdout"
      loop:
        - bulk/media
        - bulk/photos
        - bulk/kubernetes/nfs-dynamic
        - bulk/backups
        - bulk/backups/proxmox
        - bulk/backups/restic-repo
        - bulk/backups/forgejo
        - bulk/backups/timemachine
        - bulk/archive
        - bulk/signoz-cold
      tags: [datasets, bulk]

    - name: Check if fast pool exists
      ansible.builtin.command:
        cmd: midclt call pool.query '[["name", "=", "fast"]]'
      register: fast_pool_check
      changed_when: false
      tags: [always]

    - name: Verify fast pool datasets exist
      ansible.builtin.command:
        cmd: midclt call pool.dataset.query '[["id", "=", "{{ item }}"]]'
      register: fast_datasets
      changed_when: false
      failed_when: "'[]' == fast_datasets.stdout"
      loop:
        - fast/kubernetes/nfs-dynamic
        - fast/kubernetes/nfs-static
        - fast/kubernetes/iscsi-zvols
        - fast/vms
        - fast/ml-models
      when: fast_pool_check.stdout != '[]'
      tags: [datasets, fast]

    - name: Verify scratch pool datasets exist
      ansible.builtin.command:
        cmd: midclt call pool.dataset.query '[["id", "=", "{{ item }}"]]'
      register: scratch_datasets
      changed_when: false
      failed_when: "'[]' == scratch_datasets.stdout"
      loop:
        - scratch/kubernetes/nfs-dynamic
        - scratch/downloads/incomplete
        - scratch/downloads/complete
        - scratch/ci-runners/cache
        - scratch/ci-runners/artifacts
        - scratch/ml-datasets
        - scratch/temp
        - scratch/immich-migration
        - scratch/dump
      tags: [datasets, scratch]

    # Dataset properties
    - name: Query bulk/media recordsize
      ansible.builtin.command:
        cmd: >-
          midclt call pool.dataset.query
          '[["id", "=", "bulk/media"]]'
          '{"select": ["recordsize"]}'
      register: media_recordsize
      changed_when: false
      failed_when: "'1M' not in media_recordsize.stdout"
      tags: [properties, bulk]

    - name: Query bulk/photos recordsize
      ansible.builtin.command:
        cmd: >-
          midclt call pool.dataset.query
          '[["id", "=", "bulk/photos"]]'
          '{"select": ["recordsize"]}'
      register: photos_recordsize
      changed_when: false
      failed_when: "'1M' not in photos_recordsize.stdout"
      tags: [properties, bulk]

    # Services
    - name: Verify NFS service is running
      ansible.builtin.command:
        cmd: midclt call service.query '[["service", "=", "nfs"]]'
      register: nfs_service
      changed_when: false
      failed_when: "'RUNNING' not in nfs_service.stdout"
      tags: [services, nfs]

    - name: Verify iSCSI service is running
      ansible.builtin.command:
        cmd: midclt call service.query '[["service", "=", "iscsitarget"]]'
      register: iscsi_service
      changed_when: false
      failed_when: "'RUNNING' not in iscsi_service.stdout"
      tags: [services, iscsi]

    - name: Verify SMB service is running
      ansible.builtin.command:
        cmd: midclt call service.query '[["service", "=", "cifs"]]'
      register: smb_service
      changed_when: false
      failed_when: "'RUNNING' not in smb_service.stdout"
      tags: [services, smb]

    # NFS shares
    - name: Query all NFS shares
      ansible.builtin.command:
        cmd: midclt call sharing.nfs.query
      register: nfs_shares_result
      changed_when: false
      tags: [nfs]

    - name: Verify expected NFS share paths exist
      ansible.builtin.assert:
        that:
          - item.path in (nfs_shares_result.stdout | from_json | map(attribute='path') | list)
        fail_msg: "NFS share missing: {{ item.path }}"
        quiet: true
      loop: "{{ nfs_shares | rejectattr('path', 'match', '/mnt/fast/') | list if fast_pool_check.stdout == '[]' else nfs_shares
        }}"
      loop_control:
        label: "{{ item.path }}"
      tags: [nfs]

    # SMB shares
    - name: Query all SMB shares
      ansible.builtin.command:
        cmd: midclt call sharing.smb.query
      register: smb_shares_result
      changed_when: false
      tags: [smb]

    - name: Verify expected SMB share names exist
      ansible.builtin.assert:
        that:
          - item.name in (smb_shares_result.stdout | from_json | map(attribute='name') | list)
        fail_msg: "SMB share missing: {{ item.name }}"
        quiet: true
      loop: "{{ smb_shares }}"
      loop_control:
        label: "{{ item.name }}"
      tags: [smb]

    # Users and groups
    - name: Verify storage users exist
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "{{ item.name }}"]]'
      register: user_check
      changed_when: false
      failed_when: "'[]' == user_check.stdout"
      loop: "{{ storage_users }}"
      loop_control:
        label: "{{ item.name }}"
      tags: [users]

    - name: Verify storage groups exist
      ansible.builtin.command:
        cmd: midclt call group.query '[["group", "=", "{{ item.name }}"]]'
      register: group_check
      changed_when: false
      failed_when: "'[]' == group_check.stdout"
      loop: "{{ storage_groups }}"
      loop_control:
        label: "{{ item.name }}"
      tags: [users]

    - name: Verify dumper user exists with UID 1003
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "dumper"]]'
      register: dumper_user_check
      changed_when: false
      failed_when: >
        dumper_user_check.stdout == '[]'
        or (dumper_user_check.stdout | from_json)[0].uid != 1003
      tags: [users]

    - name: Query media group ID for membership checks
      ansible.builtin.command:
        cmd: midclt call group.query '[["group", "=", "media"]]'
      register: verify_media_group
      changed_when: false
      tags: [users]

    - name: Verify immich is in media group
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "immich"]]'
      register: immich_user_info
      changed_when: false
      failed_when: >
        immich_user_info.stdout == '[]'
        or (verify_media_group.stdout | from_json)[0].id not in (immich_user_info.stdout | from_json)[0].groups
      tags: [users]

    - name: Verify svenlito is in media group
      ansible.builtin.command:
        cmd: midclt call user.query '[["username", "=", "svenlito"]]'
      register: svenlito_user_info
      changed_when: false
      failed_when: >
        svenlito_user_info.stdout == '[]'
        or (verify_media_group.stdout | from_json)[0].id not in (svenlito_user_info.stdout | from_json)[0].groups
      tags: [users]

    # NFS shares — verify no mapall (all should use maproot)
    # TrueNAS API always returns mapall_user/mapall_group as null when not set
    - name: Verify no NFS shares use mapall
      ansible.builtin.assert:
        that:
          - nfs_shares_result.stdout | from_json | map(attribute='mapall_user') | reject('none') | reject('equalto', '') |
            list | length == 0
          - nfs_shares_result.stdout | from_json | map(attribute='mapall_group') | reject('none') | reject('equalto', '')
            | list | length == 0
        fail_msg: "Found NFS shares still using mapall — all should use maproot"
        quiet: true
      tags: [nfs, acls]

    # Dataset ACL properties
    - name: Verify service datasets have NFSv4 ACL type (passthrough)
      ansible.builtin.command:
        cmd: >-
          midclt call pool.dataset.query
          '[["id", "=", "{{ item }}"]]'
          '{"select": ["acltype", "aclmode"]}'
      register: acl_props
      changed_when: false
      failed_when: >
        'NFSV4' not in acl_props.stdout
        or 'PASSTHROUGH' not in acl_props.stdout
      loop:
        - bulk/media
        - bulk/photos
        - bulk/archive
        - scratch
        - scratch/downloads
        - scratch/downloads/complete
        - scratch/immich-migration
        - scratch/dump
      tags: [acls, datasets]

    - name: Verify Time Machine dataset has NFSv4 ACL type (restricted)
      ansible.builtin.command:
        cmd: >-
          midclt call pool.dataset.query
          '[["id", "=", "bulk/backups/timemachine"]]'
          '{"select": ["acltype", "aclmode"]}'
      register: tm_acl_props
      changed_when: false
      failed_when: >
        'NFSV4' not in tm_acl_props.stdout
        or 'RESTRICTED' not in tm_acl_props.stdout
      tags: [acls, datasets]

    # NFSv4 ACL entries (getacl defaults to simplified=true, returns BASIC flags)
    - name: Verify NFSv4 ACLs on service datasets
      ansible.builtin.command:
        cmd: midclt call filesystem.getacl '"/mnt/{{ item.path }}"'
      register: acl_check
      changed_when: false
      failed_when: >
        (acl_check.stdout | from_json).acl
        | selectattr('tag', 'equalto', 'owner@')
        | selectattr('perms.BASIC', 'defined')
        | selectattr('perms.BASIC', 'equalto', 'FULL_CONTROL')
        | list | length == 0
        or
        (acl_check.stdout | from_json).acl
        | selectattr('tag', 'equalto', 'group@')
        | selectattr('perms.BASIC', 'defined')
        | selectattr('perms.BASIC', 'equalto', 'MODIFY')
        | list | length == 0
      loop:
        - path: bulk/media
        - path: bulk/photos
        - path: bulk/archive
        - path: scratch/downloads
        - path: scratch/downloads/complete
        - path: scratch/immich-migration
        - path: scratch/dump
      # bulk/backups/timemachine excluded — SMB manages its own ACLs
      loop_control:
        label: "{{ item.path }}"
      tags: [acls]

    # Directory structure and permissions
    - name: Verify bulk/media subdirectories exist
      ansible.builtin.stat:
        path: "/mnt/bulk/media/{{ item }}"
      register: media_dirs
      failed_when: not media_dirs.stat.exists
      loop:
        - movies
        - tv
        - music
        - books
      tags: [permissions, bulk]

    - name: Check bulk/media ownership is media:media (1000:1000)
      ansible.builtin.stat:
        path: /mnt/bulk/media
      register: media_stat
      failed_when: media_stat.stat.uid != 1000 or media_stat.stat.gid != 1000
      tags: [permissions, bulk]

    # Network
    - name: Verify storage VLAN interface has correct IP
      ansible.builtin.command:
        cmd: midclt call interface.query '[["name", "=", "enp6s19"]]'
      register: storage_iface
      changed_when: false
      failed_when: "'10.10.10.13' not in storage_iface.stdout"
      tags: [network]

    # Scrub tasks
    - name: Query scrub tasks
      ansible.builtin.command:
        cmd: midclt call pool.scrub.query
      register: scrub_tasks
      changed_when: false
      tags: [scrub]

    - name: Verify scrub tasks exist for all pools
      ansible.builtin.assert:
        that:
          - item in (scrub_tasks.stdout | from_json | map(attribute='pool_name') | list)
        fail_msg: "Scrub task missing for pool: {{ item }}"
        quiet: true
      loop: "{{ ['bulk', 'scratch'] + (['fast'] if fast_pool_check.stdout != '[]' else []) }}"
      tags: [scrub]

    # Snapshot tasks
    - name: Query snapshot tasks
      ansible.builtin.command:
        cmd: midclt call pool.snapshottask.query
      register: snapshot_tasks
      changed_when: false
      tags: [snapshots]

    - name: Verify snapshot tasks exist for expected datasets
      ansible.builtin.assert:
        that:
          - item in (snapshot_tasks.stdout | from_json | map(attribute='dataset') | list)
        fail_msg: "Snapshot task missing for dataset: {{ item }}"
        quiet: true
      loop: >-
        {{ ['bulk/media', 'bulk/photos']
           + (['fast/kubernetes', 'fast/vms', 'fast/ml-models'] if fast_pool_check.stdout != '[]' else []) }}
      tags: [snapshots]

    # iSCSI portal and initiator (only relevant when fast pool exists)
    - name: Query iSCSI portals
      ansible.builtin.command:
        cmd: midclt call iscsi.portal.query
      register: iscsi_portals
      changed_when: false
      when: fast_pool_check.stdout != '[]'
      tags: [iscsi]

    - name: Verify iSCSI portal exists on storage VLAN
      ansible.builtin.assert:
        that:
          - iscsi_portals.stdout | from_json | length > 0
          - "'10.10.10.13' in (iscsi_portals.stdout | from_json | map(attribute='listen') | flatten | map(attribute='ip')
            | list)"
        fail_msg: "iSCSI portal missing or not listening on 10.10.10.13"
        quiet: true
      when: fast_pool_check.stdout != '[]'
      tags: [iscsi]

    - name: Query iSCSI initiator groups
      ansible.builtin.command:
        cmd: midclt call iscsi.initiator.query
      register: iscsi_initiators
      changed_when: false
      when: fast_pool_check.stdout != '[]'
      tags: [iscsi]

    - name: Verify iSCSI initiator group exists with K8s networks
      ansible.builtin.assert:
        that:
          - iscsi_initiators.stdout | from_json | length > 0
        fail_msg: "iSCSI initiator group missing"
        quiet: true
      when: fast_pool_check.stdout != '[]'
      tags: [iscsi]
