---
# Configure VLAN bridges on Proxmox hosts.
# If SSH connection is lost, use iDRAC to troubleshoot.

- name: Configure Proxmox Network Bridges
  hosts: proxmox
  become: true
  gather_facts: true

  vars:
    gateway_ip: "192.168.0.1"

  tasks:
    - name: Set host-specific IPs for grogu
      set_fact:
        storage_ip: "10.10.10.10"
        management_ip: "192.168.0.10"
      when: inventory_hostname == 'grogu'

    - name: Set host-specific IPs for din
      set_fact:
        storage_ip: "10.10.10.11"
        management_ip: "192.168.0.11"
      when: inventory_hostname == 'din'

    - name: Display configuration summary
      debug:
        msg: |
          Configuring {{ inventory_hostname }}:
            - Management (vmbr20): {{ management_ip }}/24
            - Storage (vmbr10): {{ storage_ip }}/24
            - K8s Shared (vmbr30): No IP (VMs only)
            - K8s Apps (vmbr31): No IP (VMs only)
            - K8s Test (vmbr32): No IP (VMs only)
            - Gateway: {{ gateway_ip }}

    - name: Apply proxmox_networking role
      include_role:
        name: proxmox_networking

  post_tasks:
    - name: Verify bridges are configured
      command: ip addr show
      register: ip_addr_output
      changed_when: false

    - name: Check for new bridges
      debug:
        msg: "Bridges configured: {{ ip_addr_output.stdout | regex_findall('vmbr\\d+') | unique | sort }}"
