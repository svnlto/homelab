---
# Configure ZFS replication from din (primary) to grogu (backup).
# Requires SSH keys set up between the two TrueNAS instances.

- name: Setup ZFS replication from din to grogu
  hosts: truenas_primary
  become: true

  vars_files:
    - ../vars/snapshots.yml

  tasks:
    # SSH key setup
    - name: Generate SSH keypair for replication
      ansible.builtin.command:
        cmd: >
          midclt call keychaincredential.create '{
            "name": "replication-to-grogu",
            "type": "SSH_KEY_PAIR",
            "attributes": {}
          }'
      register: keypair_result
      changed_when: "'id' in keypair_result.stdout"
      failed_when: false
      tags: [ssh, setup]

    - name: Extract keypair ID
      ansible.builtin.set_fact:
        keypair_id: "{{ (keypair_result.stdout | from_json).id }}"
      when: "'id' in keypair_result.stdout"
      tags: [ssh, setup]

    - name: Get public key for manual setup on grogu
      ansible.builtin.command:
        cmd: >
          midclt call keychaincredential.query '[["id", "=", {{ keypair_id }}]]'
      register: keypair_info
      when: keypair_id is defined
      changed_when: false
      tags: [ssh, setup]

    - name: Display public key
      ansible.builtin.debug:
        msg: |
          Copy this public key to grogu backup TrueNAS (192.168.0.14)
          and add it to /root/.ssh/authorized_keys:

          {{ (keypair_info.stdout | from_json)[0].attributes.public_key }}
      when: keypair_info is defined and keypair_info.stdout is defined
      tags: [ssh, setup]

    # Replication tasks must be created via TrueNAS GUI or midclt after SSH
    # credentials are configured. The arensb.truenas collection doesn't have
    # replication task support yet.
    #
    # After SSH setup, create tasks with midclt call replication.create:
    #   - fast/kubernetes -> backup/kubernetes (hourly)
    #   - fast/vms -> backup/vms (every 4 hours)
    #   - bulk/photos -> backup/photos (daily)
    #   - fast/ml-models -> backup/ml-models (daily)
    #   - bulk/media -> backup/media (daily)

    - name: Display replication setup instructions
      ansible.builtin.debug:
        msg: |
          1. Ensure backup TrueNAS (grogu) has 'backup' pool created
          2. SSH to din (192.168.0.13) as root
          3. Get grogu's host key: ssh-keyscan -H 192.168.0.14
          4. Create SSH credential via midclt (see comments in playbook)
          5. Create replication tasks via midclt
          6. Verify: midclt call replication.query
      tags: [info]

- name: Verify backup TrueNAS (grogu) readiness
  hosts: truenas_backup
  become: true
  gather_facts: false

  tasks:
    - name: Check if backup pool exists
      ansible.builtin.command:
        cmd: midclt call pool.query '[["name", "=", "backup"]]'
      register: backup_pool
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Display backup pool status
      ansible.builtin.debug:
        msg: |
          {% if backup_pool.stdout | from_json | length > 0 %}
          Backup pool 'backup' exists on grogu
          {% else %}
          Backup pool 'backup' NOT FOUND on grogu - create pool before replication
          {% endif %}
      when: backup_pool.rc == 0
      tags: [verify]

    - name: Create backup datasets if pool exists
      ansible.builtin.command:
        cmd: >
          midclt call pool.dataset.create '{
            "name": "backup/{{ item }}",
            "type": "FILESYSTEM"
          }'
      loop:
        - media
        - kubernetes
        - vms
        - ml-models
        - backups
      when: backup_pool.stdout | from_json | length > 0
      register: dataset_creation
      changed_when: "'id' in dataset_creation.stdout"
      failed_when: false
      tags: [verify, datasets]
