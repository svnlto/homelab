---
# Configure Proxmox VE nodes after ISO installation.
# Applies common config: packages, locale, subscription nag, SSH, passthrough, fan control.

- name: Configure Existing Proxmox Nodes
  hosts: proxmox
  become: true
  gather_facts: true

  vars:
    pve_remove_subscription_warning: true
    configure_pcie_passthrough: true

  pre_tasks:
    - name: Display node information
      ansible.builtin.debug:
        msg:
          - "Configuring: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "Proxmox Web UI: https://{{ ansible_host }}:8006"

    - name: Verify Proxmox VE is installed
      ansible.builtin.stat:
        path: /usr/bin/pvesh
      register: pvesh_stat
      failed_when: not pvesh_stat.stat.exists

  tasks:
    - name: Install common packages
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: packages.yml
      tags: [packages]

    - name: Fix locale settings
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: fix_locales.yml
      tags: [locales]

    - name: Remove subscription nag
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: remove_subscription_nag.yml
      when: pve_remove_subscription_warning | default(true)
      tags: [nag]

    - name: Configure PCIe passthrough
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: pcie_passthrough.yml
      when: configure_pcie_passthrough | default(false)
      tags: [passthrough]

    - name: Configure NTP with chrony
      ansible.builtin.template:
        src: ../roles/proxmox_configure/templates/chrony.conf.j2
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: "0644"
        backup: true
      notify: Restart chrony
      tags: [ntp]

    - name: Enable and start chrony
      ansible.builtin.systemd:
        name: chrony
        enabled: true
        state: started
      tags: [ntp]

    - name: Ensure .ssh directory exists for root
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"
      tags: [ssh]

    - name: Add SSH public key to root authorized_keys
      ansible.posix.authorized_key:
        user: root
        key: "{{ proxmox_ssh_public_key }}"
        state: present
      when: proxmox_ssh_public_key is defined
      tags: [ssh]

    - name: Harden SSH configuration
      ansible.builtin.include_role:
        name: security
        apply:
          tags: [ssh]
      tags: [ssh]

    - name: Allow unsupported SFP+ modules
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: ixgbe_unsupported_sfp.yml
      when: configure_ixgbe_unsupported_sfp | default(false)
      tags: [ixgbe]

    - name: Configure PCI resource mappings
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: pci_resource_mappings.yml
        apply:
          tags: [passthrough, pci-mappings]
      when: pci_resource_mappings is defined and pci_resource_mappings | length > 0
      tags: [passthrough, pci-mappings]

    - name: Configure Dell fan control
      ansible.builtin.include_role:
        name: proxmox_configure
        tasks_from: dell_fan_control.yml
      tags: [fan]

    - name: Create Terraform API tokens
      ansible.builtin.include_role:
        name: proxmox_api_tokens
        apply:
          tags: [api-tokens]
      tags: [api-tokens]

  handlers:
    - name: Restart chrony
      ansible.builtin.systemd:
        name: chrony
        state: restarted

    - name: Update GRUB
      ansible.builtin.command: update-grub
      changed_when: true

    - name: Refresh proxmox-boot-tool
      ansible.builtin.command: proxmox-boot-tool refresh
      changed_when: true

  post_tasks:
    - name: Update initramfs (if passthrough configured)
      ansible.builtin.command: update-initramfs -u -k all
      changed_when: true
      when: configure_pcie_passthrough | default(false)

    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "Configuration complete for {{ inventory_hostname }}"
          - "Access: https://{{ ansible_host }}:8006"
          - "{% if configure_pcie_passthrough %}REBOOT REQUIRED for PCIe passthrough changes{% endif %}"

    - name: Reminder to reload environment
      ansible.builtin.debug:
        msg:
          - "API Tokens saved to 1Password"
          - "Reload direnv to pick up new tokens: direnv allow"
      run_once: true
      tags: [api-tokens]
