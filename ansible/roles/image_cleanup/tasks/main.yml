---
# =============================================================================
# Role: image_cleanup
# Prepares the system for imaging (removes machine-specific data)
# =============================================================================

- name: Stop logging services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
  loop:
    - rsyslog
  failed_when: false

- name: Clean apt cache
  ansible.builtin.apt:
    autoclean: true
    autoremove: true

- name: Remove apt lists
  ansible.builtin.file:
    path: /var/lib/apt/lists
    state: absent

- name: Recreate apt lists directory
  ansible.builtin.file:
    path: /var/lib/apt/lists/partial
    state: directory
    mode: "0755"

- name: Remove SSH host keys (will be regenerated on first boot)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/ssh/ssh_host_rsa_key
    - /etc/ssh/ssh_host_rsa_key.pub
    - /etc/ssh/ssh_host_dsa_key
    - /etc/ssh/ssh_host_dsa_key.pub
    - /etc/ssh/ssh_host_ecdsa_key
    - /etc/ssh/ssh_host_ecdsa_key.pub
    - /etc/ssh/ssh_host_ed25519_key
    - /etc/ssh/ssh_host_ed25519_key.pub

- name: Clear machine-id
  ansible.builtin.copy:
    content: ""
    dest: /etc/machine-id
    owner: root
    group: root
    mode: "0444"

- name: Remove dbus machine-id
  ansible.builtin.file:
    path: /var/lib/dbus/machine-id
    state: absent

- name: Truncate log files
  ansible.builtin.shell: |
    find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
    find /var/log -type f -name "*.gz" -delete
    find /var/log -type f -name "*.[0-9]" -delete
  changed_when: false

- name: Clear specific log files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/log/wtmp
    - /var/log/btmp
    - /var/log/lastlog
    - /var/log/auth.log
    - /var/log/syslog
    - /var/log/messages
    - /var/log/kern.log

- name: Recreate empty log files
  ansible.builtin.file:
    path: "{{ item }}"
    state: touch
    mode: "0640"
  loop:
    - /var/log/wtmp
    - /var/log/btmp
    - /var/log/lastlog

- name: Clear temp directories
  ansible.builtin.shell: |
    rm -rf /tmp/*
    rm -rf /var/tmp/*
  changed_when: false

- name: Clear bash history for root
  ansible.builtin.file:
    path: /root/.bash_history
    state: absent

- name: Clear shell history
  ansible.builtin.shell: |
    unset HISTFILE
    history -c
  changed_when: false
  failed_when: false

- name: Remove ansible facts cache
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: absent
  failed_when: false

- name: Sync filesystem
  ansible.builtin.command: sync
  changed_when: false

- name: Display cleanup complete message
  ansible.builtin.debug:
    msg: "Image cleanup complete. Ready for imaging."
