---
- name: Create observability directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode | default('0755') }}"
    owner: "{{ item.owner | default(omit) }}"
    group: "{{ item.group | default(omit) }}"
  loop:
    - {path: "{{ data_location }}"}
    - {path: "{{ data_location }}/prometheus/config"}
    - {path: "{{ data_location }}/prometheus/data", owner: "65534", group: "65534"} # nobody user for Prometheus
    - {path: "{{ data_location }}/loki/config"}
    - {path: "{{ data_location }}/loki/data", owner: "10001", group: "10001"} # Loki user
    - {path: "{{ data_location }}/alloy"}
    - {path: "{{ data_location }}/grafana", owner: "472", group: "472"} # Grafana user
    - {path: "{{ data_location }}/grafana/provisioning/datasources", owner: "472", group: "472",}

- name: Template Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ data_location }}/prometheus/config/prometheus.yml"
    mode: '0644'
  register: prometheus_config

- name: Template Loki configuration
  ansible.builtin.template:
    src: loki.yml.j2
    dest: "{{ data_location }}/loki/config/local-config.yaml"
    mode: '0644'
  register: loki_config

- name: Template Alloy configuration
  ansible.builtin.template:
    src: alloy-config.alloy.j2
    dest: "{{ data_location }}/alloy/config.alloy"
    mode: '0644'
  register: alloy_config

- name: Template Grafana datasources
  ansible.builtin.template:
    src: grafana-datasources.yml.j2
    dest: "{{ data_location }}/grafana/provisioning/datasources/datasources.yml"
    mode: '0644'
  register: grafana_datasources

- name: Template docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ data_location }}/../docker-compose.yml"
    mode: '0644'
  register: compose_file

- name: Pull latest images
  community.docker.docker_compose_v2:
    project_src: "{{ data_location }}/.."
    pull: always
    state: present
  when: compose_file.changed or prometheus_config.changed or loki_config.changed or alloy_config.changed

- name: Deploy observability stack
  community.docker.docker_compose_v2:
    project_src: "{{ data_location }}/.."
    state: present
  register: deploy_result

- name: Display deployment status
  ansible.builtin.debug:
    msg: "Observability stack deployed. Services: {{ deploy_result.containers | map(attribute='Name') | list }}"
