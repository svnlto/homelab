---
# Switch from Proxmox enterprise repos to no-subscription (community) repos.
# Proxmox 9 (trixie) uses DEB822 .sources format.

- name: Remove Proxmox enterprise repository
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/pve-enterprise.sources
    state: absent

- name: Remove Ceph enterprise repository
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/ceph.sources
    state: absent

- name: Add Proxmox no-subscription repository
  ansible.builtin.copy:
    content: |
      Types: deb
      URIs: http://download.proxmox.com/debian/pve
      Suites: {{ ansible_distribution_release }}
      Components: pve-no-subscription
      Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
    dest: /etc/apt/sources.list.d/pve-no-subscription.sources
    owner: root
    group: root
    mode: "0644"

- name: Add Ceph no-subscription repository
  ansible.builtin.copy:
    content: |
      Types: deb
      URIs: http://download.proxmox.com/debian/ceph-squid
      Suites: {{ ansible_distribution_release }}
      Components: no-subscription
      Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
    dest: /etc/apt/sources.list.d/ceph-no-subscription.sources
    owner: root
    group: root
    mode: "0644"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
