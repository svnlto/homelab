---
# Configure Proxmox PCI resource mappings via pvesh API.
# pmxcfs doesn't support standard file operations, so we use the API instead.

- name: Configure PCI resource mappings # noqa: no-changed-when
  ansible.builtin.shell: |
    if pvesh get /cluster/mapping/pci/{{ item.key }} >/dev/null 2>&1; then
      pvesh set /cluster/mapping/pci/{{ item.key }} \
        --description '{{ item.value.description }}' \
        --map 'id={{ item.value.device_id }},iommugroup={{ item.value.iommu_group }},node={{ inventory_hostname }},path={{ item.value.path }},subsystem-id={{ item.value.subsystem_id }}'
    else
      pvesh create /cluster/mapping/pci \
        --id {{ item.key }} \
        --description '{{ item.value.description }}' \
        --map 'id={{ item.value.device_id }},iommugroup={{ item.value.iommu_group }},node={{ inventory_hostname }},path={{ item.value.path }},subsystem-id={{ item.value.subsystem_id }}'
    fi
  loop: "{{ pci_resource_mappings | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: pci_resource_mappings is defined
  tags: [passthrough, pci-mappings]
