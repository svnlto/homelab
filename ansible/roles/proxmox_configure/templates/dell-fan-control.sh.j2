#!/bin/bash
# Dell Fan Control Script
# Adjusts fan speed based on inlet and CPU temperatures via IPMI

IPMI_HOST=localhost

enable_manual() {
    ipmitool raw 0x30 0x30 0x01 0x00
}

enable_auto() {
    ipmitool raw 0x30 0x30 0x01 0x01
}

set_fan_speed() {
    ipmitool raw 0x30 0x30 0x02 0xff "$1"
}

get_inlet_temp() {
    ipmitool sdr type temperature | grep -i "inlet\|ambient" | head -1 | awk -F'|' '{print $5}' | grep -oP '\d+'
}

get_max_cpu_temp() {
    ipmitool sdr type temperature | grep -E '^Temp\s' | awk -F'|' '{print $5}' | grep -oP '\d+' | sort -rn | head -1
}

# Fail safe on exit - always restore automatic control
trap 'enable_auto; exit' SIGTERM SIGINT

enable_manual

while true; do
    INLET=$(get_inlet_temp)
    CPU=$(get_max_cpu_temp)

    # If we can't read temps, fail safe to automatic
    if [[ -z "$INLET" ]] || [[ -z "$CPU" ]]; then
        enable_auto
        sleep 30
        continue
    fi

    # Determine fan speed from inlet temp
{% for entry in fan_curve.inlet %}
    {{ "if" if loop.first else "elif" }} (( INLET >= {{ entry.temp }} )); then
        SPEED={{ entry.speed }}
{% endfor %}
    else
        SPEED={{ fan_curve.inlet_default_speed }}
    fi

    # CPU temp override - takes priority if CPUs are hot
{% for entry in fan_curve.cpu %}
    {{ "if" if loop.first else "elif" }} (( CPU >= {{ entry.temp }} )); then
        SPEED={{ entry.speed }}
{% endfor %}
    fi

    set_fan_speed "$SPEED"
    sleep 30
done
