---
# Common tasks for all Kubernetes nodes

- name: Set hostname
  hostname:
    name: "{{ node_name }}"

- name: Update /etc/hosts with all cluster nodes
  lineinfile:
    path: /etc/hosts
    line: "{{ hostvars[item].node_ip }} {{ hostvars[item].node_name }}"
    state: present
  loop: "{{ groups['k8s_cluster'] }}"

- name: Set timezone
  timezone:
    name: "{{ timezone }}"

- name: Install additional system packages
  apt:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes

- name: Ensure br_netfilter module is loaded
  modprobe:
    name: br_netfilter
    state: present

- name: Ensure overlay module is loaded
  modprobe:
    name: overlay
    state: present

- name: Verify kubelet service is enabled
  systemd:
    name: kubelet
    enabled: yes

- name: Check if node is already in cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Set fact for cluster membership
  set_fact:
    node_in_cluster: "{{ kubelet_conf.stat.exists }}"
