---
# =============================================================================
# Role: proxmox_install
# Installs Proxmox VE packages on Debian
# =============================================================================

- name: Set Proxmox repository configuration
  ansible.builtin.set_fact:
    pve_repo_url: "http://download.proxmox.com/debian/pve"
    pve_repo_suite: "bookworm"
    pve_repo_component: "{{ pve_repository }}"

- name: Display repository configuration
  ansible.builtin.debug:
    msg: "Using repository: deb {{ pve_repo_url }} {{ pve_repo_suite }} {{ pve_repo_component }}"

- name: Add Proxmox VE repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] {{ pve_repo_url }} {{ pve_repo_suite }} {{ pve_repo_component }}"
    filename: pve-install-repo
    state: present
    update_cache: false

- name: Download Proxmox GPG key
  ansible.builtin.get_url:
    url: "https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg"
    dest: "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg"
    mode: "0644"

- name: Update apt cache after adding Proxmox repo
  ansible.builtin.apt:
    update_cache: true

- name: Preconfigure postfix for non-interactive installation
  ansible.builtin.debconf:
    name: postfix
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype }}"
  loop:
    - {question: "postfix/mailname", value: "{{ node_hostname }}.{{ node_domain }}", vtype: "string"}
    - {question: "postfix/main_mailer_type", value: "Local only", vtype: "select",}

- name: Install Proxmox VE metapackage
  ansible.builtin.apt:
    name: proxmox-ve
    state: present
    install_recommends: false
  environment:
    DEBIAN_FRONTEND: noninteractive
  async: 3600
  poll: 10

- name: Install supporting packages
  ansible.builtin.apt:
    name:
      - postfix
      - open-iscsi
      - chrony
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Install Ceph packages
  ansible.builtin.apt:
    name:
      - ceph-common
      - ceph
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive
  async: 3600
  poll: 10
  when: install_ceph | default(false)

- name: Install ZFS support
  ansible.builtin.apt:
    name:
      - zfsutils-linux
      - zfs-initramfs
    state: present
  when: install_zfs | default(false)

- name: Install cloud-init
  ansible.builtin.apt:
    name:
      - cloud-init
      - cloud-initramfs-growroot
    state: present
  when: install_cloud_init | default(false)

- name: Remove Debian kernel
  ansible.builtin.apt:
    name:
      - linux-image-amd64
    state: absent
    purge: true
  failed_when: false

- name: Remove specific Debian kernel packages
  ansible.builtin.apt:
    name: 'linux-image-6.1*'
    state: absent
    purge: true
  failed_when: false

- name: Update GRUB configuration
  ansible.builtin.command: update-grub
  changed_when: false
  when: false # Deferred to playbook post_tasks

- name: Remove os-prober package
  ansible.builtin.apt:
    name: os-prober
    state: absent
    purge: true
  failed_when: false

- name: Clean up apt cache
  ansible.builtin.apt:
    autoclean: true
    autoremove: true
