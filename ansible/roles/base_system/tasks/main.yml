---
# =============================================================================
# Role: base_system
# Configures the base Debian system for Proxmox VE
# =============================================================================

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ node_hostname }}"

- name: Configure /etc/hosts for Proxmox
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: "0644"
    backup: true

- name: Ensure hostname resolves correctly
  ansible.builtin.command: hostname --ip-address
  register: hostname_check
  changed_when: false
  failed_when: "'127.0.0.1' in hostname_check.stdout or hostname_check.rc != 0"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist
    autoclean: true
    autoremove: true
  when: upgrade_packages | default(false)

- name: Install essential packages
  ansible.builtin.apt:
    name: "{{ base_packages }}"
    state: present
  vars:
    base_packages:
      - curl
      - wget
      - gnupg2
      - apt-transport-https
      - ca-certificates
      - lsb-release
      - bridge-utils
      - ifupdown2
      - parted
      - gdisk
      - hdparm
      - lm-sensors
      - ethtool
      - net-tools
      - dnsutils
      - tcpdump
      - vim
      - htop
      - iotop
      - ncdu
      - tree
      - jq

- name: Configure timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"

- name: Configure locale
  ansible.builtin.debconf:
    name: locales
    question: locales/default_environment_locale
    value: "{{ locale | default('en_US.UTF-8') }}"
    vtype: select

- name: Generate locale
  ansible.builtin.command: locale-gen {{ locale | default('en_US.UTF-8') }}
  changed_when: false

- name: Configure kernel parameters for virtualization
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-proxmox.conf
    reload: true
  loop:
    - {key: "net.ipv4.ip_forward", value: "1"}
    - {key: "net.ipv4.conf.all.rp_filter", value: "1"}
    - {key: "net.ipv6.conf.all.forwarding", value: "1"}
    - {key: "net.bridge.bridge-nf-call-iptables", value: "1"}
    - {key: "net.bridge.bridge-nf-call-ip6tables", value: "1"}
    - {key: "vm.swappiness", value: "10"}
  failed_when: false # Bridge module might not be loaded yet
