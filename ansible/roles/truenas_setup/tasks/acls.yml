---
# NFSv4 ACLs â€” owner@ FULL_CONTROL, group@ MODIFY, everyone@ READ (with inheritance)
# Uses explicit permissions (not BASIC presets) so Samba vfs_ixnas produces trivial ACLs
# that macOS Finder can read. BASIC presets create non-trivial ACLs that break Finder
# attribute fetching over SMB (Synapse EINVAL errors).

- name: Build ACL entries per dataset
  ansible.builtin.set_fact:
    _acl_base:
      - tag: "owner@"
        type: ALLOW
        perms:
          READ_DATA: true
          WRITE_DATA: true
          APPEND_DATA: true
          READ_NAMED_ATTRS: true
          WRITE_NAMED_ATTRS: true
          EXECUTE: true
          DELETE: true
          DELETE_CHILD: true
          READ_ATTRIBUTES: true
          WRITE_ATTRIBUTES: true
          READ_ACL: true
          WRITE_ACL: true
          WRITE_OWNER: true
          SYNCHRONIZE: true
        flags:
          BASIC: INHERIT
      - tag: "group@"
        type: ALLOW
        perms:
          READ_DATA: true
          WRITE_DATA: true
          APPEND_DATA: true
          READ_NAMED_ATTRS: true
          WRITE_NAMED_ATTRS: true
          EXECUTE: true
          DELETE: false
          DELETE_CHILD: false
          READ_ATTRIBUTES: true
          WRITE_ATTRIBUTES: true
          READ_ACL: true
          WRITE_ACL: false
          WRITE_OWNER: false
          SYNCHRONIZE: true
        flags:
          BASIC: INHERIT
    _acl_everyone_read:
      - tag: "everyone@"
        type: ALLOW
        perms:
          READ_DATA: true
          WRITE_DATA: false
          APPEND_DATA: false
          READ_NAMED_ATTRS: true
          WRITE_NAMED_ATTRS: false
          EXECUTE: true
          DELETE: false
          DELETE_CHILD: false
          READ_ATTRIBUTES: true
          WRITE_ATTRIBUTES: false
          READ_ACL: true
          WRITE_ACL: false
          WRITE_OWNER: false
          SYNCHRONIZE: true
        flags:
          BASIC: INHERIT
  tags: [acls]

- name: Apply NFSv4 ACLs on service datasets
  ansible.builtin.command:
    cmd: >
      midclt call filesystem.setacl
      '{{ {"path": item.path,
           "dacl": _acl_base + (_acl_everyone_read if item.everyone_read else []),
           "uid": item.uid,
           "gid": item.gid,
           "acltype": "NFS4",
           "options": {"recursive": true, "traverse": true}}
         | to_json }}'
  loop: "{{ acl_datasets }}"
  loop_control:
    label: "{{ item.path }}"
  changed_when: false
  tags: [acls]
