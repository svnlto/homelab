---
- name: Create stack directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ data_location }}"
    - "{{ data_location }}/gluetun"
    - "{{ data_location }}/jellyfin/config"
    - "{{ data_location }}/jellyfin/cache"
    - "{{ data_location }}/qbittorrent/qBittorrent/config"
    - "{{ data_location }}/sabnzbd"
    - "{{ data_location }}/radarr"
    - "{{ data_location }}/sonarr"
    - "{{ data_location }}/lidarr"
    - "{{ data_location }}/slskd"
    - "{{ data_location }}/prowlarr"
    - "{{ data_location }}/jellyseerr"
    - "{{ data_location }}/recyclarr"
    - "{{ data_location }}/buildarr"
    - "{{ data_location }}/traefik/letsencrypt"

- name: Create media directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ puid }}"
    group: "{{ pgid }}"
    mode: '0775'
  loop:
    - "{{ media_location }}"
    - "{{ media_location }}/downloads"
    - "{{ media_location }}/downloads/complete"
    - "{{ media_location }}/downloads/incomplete"
    - "{{ media_location }}/downloads/soulseek"
    - "{{ media_location }}/music"
    - "{{ media_location }}/tv"
    - "{{ media_location }}/movies"

- name: Template docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ data_location }}/../docker-compose.yml"
    mode: '0644'
  register: compose_file

- name: Template environment file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ data_location }}/../.env"
    mode: '0600'
  register: env_file

- name: Template slskd configuration
  ansible.builtin.template:
    src: slskd.yml.j2
    dest: "{{ data_location }}/slskd/slskd.yml"
    mode: '0644'
  register: slskd_config

- name: Template recyclarr configuration
  ansible.builtin.template:
    src: recyclarr.yml.j2
    dest: "{{ data_location }}/recyclarr/recyclarr.yml"
    mode: '0644'
  register: recyclarr_config

- name: Template buildarr configuration
  ansible.builtin.template:
    src: buildarr.yml.j2
    dest: "{{ data_location }}/buildarr/buildarr.yml"
    mode: '0644'
  register: buildarr_config

- name: Template qBittorrent configuration
  ansible.builtin.template:
    src: qbittorrent.conf.j2
    dest: "{{ data_location }}/qbittorrent/qBittorrent/config/qBittorrent.conf"
    mode: '0644'
  register: qbittorrent_config

- name: Template SABnzbd configuration
  ansible.builtin.template:
    src: sabnzbd.ini.j2
    dest: "{{ data_location }}/sabnzbd/sabnzbd.ini"
    mode: '0644'
  register: sabnzbd_config

- name: Pull latest images
  community.docker.docker_compose_v2:
    project_src: "{{ data_location }}/.."
    pull: always
    state: present
  when: compose_file.changed or env_file.changed or force_redeploy | default(false)

- name: Deploy stack
  community.docker.docker_compose_v2:
    project_src: "{{ data_location }}/.."
    state: present
  register: deploy_result

- name: Display deployment status
  ansible.builtin.debug:
    msg: "Stack deployed. Services: {{ deploy_result.containers | map(attribute='Name') | list }}"

- name: Wait for arr apps to initialize
  ansible.builtin.wait_for:
    port: "{{ item.port }}"
    host: localhost
    delay: 10
    timeout: 120
  loop:
    - {name: radarr, port: 7878}
    - {name: sonarr, port: 8989}
    - {name: lidarr, port: 8686}
    - {name: prowlarr, port: 9696}
  loop_control:
    label: "{{ item.name }}"

- name: Extract API keys from arr apps
  ansible.builtin.shell: |
    set -o pipefail
    docker exec {{ item.container }} cat /config/config.xml | grep -oP '<ApiKey>\K[^<]+'
  args:
    executable: /bin/bash
  register: api_keys_raw
  loop:
    - {name: radarr, container: radarr}
    - {name: sonarr, container: sonarr}
    - {name: lidarr, container: lidarr}
    - {name: prowlarr, container: prowlarr}
  loop_control:
    label: "{{ item.name }}"
  changed_when: false
  failed_when: false

- name: Set API key facts
  ansible.builtin.set_fact:
    radarr_api_key: "{{ api_keys_raw.results[0].stdout | default('') }}"
    sonarr_api_key: "{{ api_keys_raw.results[1].stdout | default('') }}"
    lidarr_api_key: "{{ api_keys_raw.results[2].stdout | default('') }}"
    prowlarr_api_key: "{{ api_keys_raw.results[3].stdout | default('') }}"

- name: Display extracted API keys
  ansible.builtin.debug:
    msg:
      - "Radarr API key: {{ radarr_api_key }}"
      - "Sonarr API key: {{ sonarr_api_key }}"
      - "Lidarr API key: {{ lidarr_api_key }}"
      - "Prowlarr API key: {{ prowlarr_api_key }}"

- name: Re-template docker-compose with API keys
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ data_location }}/../docker-compose.yml"
    mode: '0644'
  when: radarr_api_key != "" and sonarr_api_key != "" and lidarr_api_key != "" and prowlarr_api_key != ""

- name: Re-template environment file with API keys
  ansible.builtin.template:
    src: env.j2
    dest: "{{ data_location }}/../.env"
    mode: '0600'
  when: radarr_api_key != "" and sonarr_api_key != "" and lidarr_api_key != ""

- name: Restart dependent containers with API keys
  community.docker.docker_compose_v2:
    project_src: "{{ data_location }}/.."
    services:
      - exportarr-radarr
      - exportarr-sonarr
      - exportarr-lidarr
      - exportarr-prowlarr
      - buildarr
      - recyclarr
    state: restarted
  when: radarr_api_key != "" and sonarr_api_key != ""

- name: Template backup script
  ansible.builtin.template:
    src: backup-arr.sh.j2
    dest: /usr/local/bin/backup-arr.sh
    mode: '0755'
  when: enable_backups | default(true)

- name: Template health check script
  ansible.builtin.template:
    src: healthcheck-arr.sh.j2
    dest: /usr/local/bin/healthcheck-arr.sh
    mode: '0755'
  when: enable_healthchecks | default(true)

- name: Create backup directory
  ansible.builtin.file:
    path: "{{ backup_location | default('/opt/backups/arr') }}"
    state: directory
    mode: '0755'
  when: enable_backups | default(true)

- name: Schedule daily backups
  ansible.builtin.cron:
    name: "Backup arr stack configurations"
    minute: "{{ backup_cron_minute | default('0') }}"
    hour: "{{ backup_cron_hour | default('2') }}"
    job: "/usr/local/bin/backup-arr.sh >> /var/log/arr-backup.log 2>&1"
    user: root
  when: enable_backups | default(true)

- name: Schedule health checks
  ansible.builtin.cron:
    name: "Health check arr stack"
    minute: "*/{{ healthcheck_interval_minutes | default('15') }}"
    job: "/usr/local/bin/healthcheck-arr.sh >> /var/log/arr-healthcheck.log 2>&1"
    user: root
  when: enable_healthchecks | default(true)
