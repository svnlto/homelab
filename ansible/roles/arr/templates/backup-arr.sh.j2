#!/bin/bash
# Automated backup script for arr stack configurations
# Managed by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

BACKUP_DIR="{{ backup_location | default('/opt/backups/arr') }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="arr-backup-${TIMESTAMP}.tar.gz"
RETENTION_DAYS={{ backup_retention_days | default(30) }}

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

echo "Starting arr stack backup at $(date)"

# Create backup archive
tar -czf "${BACKUP_DIR}/${BACKUP_NAME}" \
  -C "{{ data_location }}/.." \
  --exclude='*.log' \
  --exclude='cache' \
  --exclude='logs' \
  --exclude='Backups' \
  data/

# Create symlink to latest backup
ln -sf "${BACKUP_DIR}/${BACKUP_NAME}" "${BACKUP_DIR}/arr-backup-latest.tar.gz"

# Remove backups older than retention period
find "${BACKUP_DIR}" -name "arr-backup-*.tar.gz" -type f -mtime +${RETENTION_DAYS} -delete

BACKUP_SIZE=$(du -h "${BACKUP_DIR}/${BACKUP_NAME}" | cut -f1)
echo "Backup completed: ${BACKUP_NAME} (${BACKUP_SIZE})"
echo "Backup location: ${BACKUP_DIR}/${BACKUP_NAME}"

# Optional: Upload to remote storage (uncomment and configure)
# rclone copy "${BACKUP_DIR}/${BACKUP_NAME}" remote:backups/arr/
