#!/bin/bash
# Health check script for arr stack services
# Managed by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

SERVICES=(
  "gluetun:http://localhost:8989"
  "jellyfin:http://localhost:8096/health"
  "qbittorrent:http://localhost:8701"
  "sabnzbd:http://localhost:8080"
  "radarr:http://localhost:7878/ping"
  "sonarr:http://localhost:8989/ping"
  "lidarr:http://localhost:8686/ping"
  "bazarr:http://localhost:6767"
  "prowlarr:http://localhost:9696/ping"
  "slskd:http://localhost:5030"
  "jellyseerr:http://localhost:5055"
)

FAILED=0
echo "=== Arr Stack Health Check at $(date) ==="

for service in "${SERVICES[@]}"; do
  name="${service%%:*}"
  url="${service#*:}"

  if curl -sf -m 5 "${url}" > /dev/null 2>&1; then
    echo "✓ ${name}: OK"
  else
    echo "✗ ${name}: FAILED"
    FAILED=$((FAILED + 1))
  fi
done

# Check Docker containers
echo ""
echo "=== Docker Container Status ==="
docker compose -f "{{ data_location }}/../docker-compose.yml" ps --format "table {{ '{{' }}.Name}}\t{{ '{{' }}.Status}}"

if [ ${FAILED} -gt 0 ]; then
  echo ""
  echo "⚠ ${FAILED} service(s) failed health check"
  exit 1
else
  echo ""
  echo "✓ All services healthy"
  exit 0
fi
