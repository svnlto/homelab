---
services:
{% if enable_traefik | default(false) %}
  traefik:
    image: traefik:v3.6.4
    container_name: traefik
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email={{ traefik_acme_email }}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - {{ data_location }}/traefik/letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`{{ traefik_domain }}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
    restart: unless-stopped
{% endif %}

  gluetun:
    image: qmcgaw/gluetun:v3.40.0
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8701:8701   # qBittorrent
      - 8080:8080   # SABnzbd
      - 7878:7878   # Radarr
      - 8989:8989   # Sonarr
      - 8686:8686   # Lidarr
      - 6767:6767   # Bazarr
      - 9696:9696   # Prowlarr
      - 8191:8191   # FlareSolverr
      - 5030:5030   # Slskd
    env_file:
      - .env
    environment:
      - VPN_SERVICE_PROVIDER={{ vpn_provider | default('protonvpn') }}
      - VPN_TYPE=openvpn
      - SERVER_COUNTRIES={{ vpn_server_countries | default('Sweden') }}
      - VPN_PORT_FORWARDING=on
      - VPN_PORT_FORWARDING_PROVIDER={{ vpn_provider | default('protonvpn') }}
      - UPDATER_PERIOD=24h
      - PORT_FORWARD_ONLY=on
    volumes:
      - {{ data_location }}/gluetun:/gluetun
    restart: unless-stopped

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:10.11.4ubu2404-ls11
    container_name: jellyfin
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/jellyfin/config:/config
      - {{ data_location }}/jellyfin/cache:/cache
      - {{ media_location }}:/data/media
    ports:
      - 8096:8096
{% if enable_traefik | default(false) %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.{{ traefik_domain }}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
{% endif %}
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4-r1-ls431
    container_name: qbittorrent
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
      - WEBUI_PORT=8701
    volumes:
      - {{ data_location }}/qbittorrent:/config
      - {{ media_location }}/downloads:/data/downloads
    depends_on:
      - gluetun
    restart: unless-stopped

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:4.5.1-ls223
    container_name: sabnzbd
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/sabnzbd:/config
      - {{ media_location }}/downloads:/data/downloads
    depends_on:
      - gluetun
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:6.0.4.10291-ls288
    container_name: radarr
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/radarr:/config
      - {{ media_location }}/downloads:/data/downloads
      - {{ media_location }}:/data/media
    depends_on:
      - gluetun
    restart: unless-stopped

  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.16.2944-ls299
    container_name: sonarr
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/sonarr:/config
      - {{ media_location }}/downloads:/data/downloads
      - {{ media_location }}:/data/media
    depends_on:
      - gluetun
    restart: unless-stopped

  lidarr:
    image: ghcr.io/hotio/lidarr:pr-plugins-3.0.0.4856
    container_name: lidarr
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/lidarr:/config
      - {{ media_location }}/downloads:/data/downloads
      - {{ media_location }}:/data/media
    depends_on:
      - gluetun
    restart: unless-stopped

  slskd:
    image: slskd/slskd:0.24.1
    container_name: slskd
    network_mode: service:gluetun
    env_file:
      - .env
    volumes:
      - {{ data_location }}/slskd:/app
      - {{ media_location }}/downloads/soulseek:/downloads
      - {{ media_location }}/music:/music:ro
    depends_on:
      - gluetun
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5030/ || exit 1"]
      interval: 2m
      timeout: 10s
      retries: 3
      start_period: 30s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:2.3.0.5236-ls133
    container_name: prowlarr
    network_mode: service:gluetun
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/prowlarr:/config
    depends_on:
      - gluetun
    restart: unless-stopped

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.4.5
    container_name: flaresolverr
    network_mode: service:gluetun
    environment:
      - LOG_LEVEL=info
      - TZ={{ timezone | default('Europe/Berlin') }}
    depends_on:
      - gluetun
    restart: unless-stopped

  jellyseerr:
    image: fallenbagel/jellyseerr:2.7.3
    container_name: jellyseerr
    environment:
      - PUID={{ puid | default(1000) }}
      - PGID={{ pgid | default(1000) }}
      - TZ={{ timezone | default('Europe/Berlin') }}
    volumes:
      - {{ data_location }}/jellyseerr:/app/config
    ports:
      - 5055:5055
{% if enable_traefik | default(false) %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyseerr.rule=Host(`requests.{{ traefik_domain }}`)"
      - "traefik.http.routers.jellyseerr.entrypoints=websecure"
      - "traefik.http.routers.jellyseerr.tls.certresolver=letsencrypt"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
{% endif %}
    restart: unless-stopped

  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:7.4.0
    container_name: recyclarr
    network_mode: service:gluetun
    env_file:
      - .env
    environment:
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
    volumes:
      - {{ data_location }}/recyclarr:/config
    depends_on:
      - gluetun
    restart: unless-stopped

  buildarr:
    image: callum027/buildarr:0.7.8
    container_name: buildarr
    network_mode: service:gluetun
    env_file:
      - .env
    environment:
      - RADARR_API_KEY=${RADARR_API_KEY:-}
      - SONARR_API_KEY=${SONARR_API_KEY:-}
      - PROWLARR_API_KEY=${PROWLARR_API_KEY:-}
    volumes:
      - {{ data_location }}/buildarr:/config
    depends_on:
      - gluetun
    restart: unless-stopped

{% if enable_observability | default(false) %}
  exportarr-radarr:
    image: ghcr.io/onedr0p/exportarr:v2.3.0
    container_name: exportarr-radarr
    command: ["radarr"]
    env_file:
      - .env
    environment:
      - PORT=9707
      - URL=http://gluetun:7878
      - APIKEY=${RADARR_API_KEY:-}
      - ENABLE_ADDITIONAL_METRICS=true
      - ENABLE_UNKNOWN_QUEUE_ITEMS=true
    ports:
      - 9707:9707
    restart: unless-stopped

  exportarr-sonarr:
    image: ghcr.io/onedr0p/exportarr:v2.3.0
    container_name: exportarr-sonarr
    command: ["sonarr"]
    env_file:
      - .env
    environment:
      - PORT=9708
      - URL=http://gluetun:8989
      - APIKEY=${SONARR_API_KEY:-}
      - ENABLE_ADDITIONAL_METRICS=true
      - ENABLE_UNKNOWN_QUEUE_ITEMS=true
    ports:
      - 9708:9708
    restart: unless-stopped

  exportarr-lidarr:
    image: ghcr.io/onedr0p/exportarr:v2.3.0
    container_name: exportarr-lidarr
    command: ["lidarr"]
    env_file:
      - .env
    environment:
      - PORT=9709
      - URL=http://gluetun:8686
      - APIKEY=${LIDARR_API_KEY:-}
      - ENABLE_ADDITIONAL_METRICS=true
    ports:
      - 9709:9709
    restart: unless-stopped

  exportarr-prowlarr:
    image: ghcr.io/onedr0p/exportarr:v2.3.0
    container_name: exportarr-prowlarr
    command: ["prowlarr"]
    env_file:
      - .env
    environment:
      - PORT=9710
      - URL=http://gluetun:9696
      - APIKEY=${PROWLARR_API_KEY:-}
      - ENABLE_ADDITIONAL_METRICS=true
    ports:
      - 9710:9710
    restart: unless-stopped

{% endif %}
