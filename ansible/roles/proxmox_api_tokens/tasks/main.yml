---
# ==============================================================================
# Proxmox API Tokens - Main Tasks
# ==============================================================================
# Creates Terraform API tokens for Proxmox automation

- name: Check if terraform user exists
  ansible.builtin.command: pveum user list
  register: user_list
  changed_when: false

- name: Create terraform user if not exists
  ansible.builtin.command: >
    pveum user add {{ terraform_user }}
    --comment "Terraform automation user"
  when: "terraform_user not in user_list.stdout"
  register: user_created
  changed_when: user_created.rc == 0

- name: Check if TerraformProv role exists
  ansible.builtin.shell: |
    set -o pipefail
    pveum role list | grep -q "TerraformProv"
  register: terraform_role_exists
  changed_when: false
  failed_when: false

- name: Create TerraformProv role
  ansible.builtin.command: >
    pveum role add TerraformProv
    -privs "Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit
    Mapping.Modify Mapping.Use Mapping.Audit
    Pool.Allocate Pool.Audit
    Sys.Audit Sys.AccessNetwork Sys.Console Sys.Modify
    VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk
    VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate
    VM.PowerMgmt SDN.Use"
  when: terraform_role_exists.rc != 0
  changed_when: true

- name: Update TerraformProv role privileges
  ansible.builtin.command: >
    pveum role modify TerraformProv
    -privs "Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit
    Mapping.Modify Mapping.Use Mapping.Audit
    Pool.Allocate Pool.Audit
    Sys.Audit Sys.AccessNetwork Sys.Console Sys.Modify
    VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk
    VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate
    VM.PowerMgmt SDN.Use"
  when: terraform_role_exists.rc == 0
  changed_when: true

- name: Assign roles to terraform user
  ansible.builtin.command: >
    pveum aclmod / -user {{ terraform_user }} -role TerraformProv
  changed_when: false

- name: Check if token already exists
  ansible.builtin.shell: |
    set -o pipefail
    pveum user token list {{ terraform_user }} | grep -q "{{ terraform_token_name }}"
  register: token_exists
  changed_when: false
  failed_when: false

- name: Delete existing terraform token (if rotating)
  ansible.builtin.command: >
    pveum user token remove {{ terraform_user }} {{ terraform_token_name }}
  when:
    - rotate_tokens | bool
    - token_exists.rc == 0
  changed_when: true

- name: Generate new API token
  ansible.builtin.command: >
    pveum user token add {{ terraform_user }} {{ terraform_token_name }}
    --privsep 0
    --output-format json
  register: token_output
  when: (rotate_tokens | bool) or (token_exists.rc != 0)
  changed_when: true

- name: Parse token from output # noqa no-handler
  ansible.builtin.set_fact:
    api_token_id: "{{ terraform_user }}!{{ terraform_token_name }}"
    api_token_secret: "{{ (token_output.stdout | from_json).value }}"
  when: token_output.changed

- name: Display token information # noqa no-handler
  ansible.builtin.debug:
    msg: |
      ========================================
      Proxmox API Token Created: {{ inventory_hostname }}
      ========================================

      Add this to your .env file:

      PROXMOX_TOKEN_ID="{{ terraform_user }}!{{ terraform_token_name }}"
      PROXMOX_TOKEN_SECRET="{{ api_token_secret }}"

      ========================================
      Token saved to 1Password (Proxmox API Token)
      Reload with: direnv allow
      ========================================
  when: token_output.changed

- name: Save token to 1Password # noqa no-handler
  delegate_to: localhost
  become: false
  ansible.builtin.shell: |
    op item edit "Proxmox API Token" \
      --vault Personal \
      'token_id={{ terraform_user }}!{{ terraform_token_name }}' \
      'token_secret={{ api_token_secret }}'
  when: token_output.changed
  changed_when: true
