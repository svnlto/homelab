{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    "docker:pinDigests",
    ":pinVersions"
  ],

  // Check immediately on every run, Europe/Berlin timezone
  "schedule": ["at any time"],
  "timezone": "Europe/Berlin",

  // Never automerge — infrastructure code requires manual review
  "automerge": false,

  // Pin versions instead of using ranges
  "rangeStrategy": "pin",

  // PR configuration
  "prHourlyLimit": 5,
  "prConcurrentLimit": 10,
  "labels": ["dependencies"],

  // Enable vulnerability alerts
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security"]
  },

  // Skip generated paths
  "ignorePaths": [
    ".terragrunt-cache/**"
  ],

  // Keep Terraform lock files up to date
  "lockFileMaintenance": {
    "enabled": true,
    "schedule": ["before 5am"]
  },

  // Custom regex managers for Nix files with Docker image references
  "customManagers": [
    {
      // Match single-line: name = "registry/image:tag";
      // Requires depName to start with [a-z] to exclude NFS device lines (${truenasIp}:...)
      "customType": "regex",
      "fileMatch": ["^nix/arr-stack/arr\\.nix$"],
      "matchStrings": [
        "\\s+\\w+\\s*=\\s*\"(?<depName>[a-z][^\"]*?):(?<currentValue>[^\"]+?)\";"
      ],
      "datasourceTemplate": "docker"
    },
    {
      // Pi-hole version in constants.nix (Docker Hub pihole/pihole)
      "customType": "regex",
      "fileMatch": ["^nix/common/constants\\.nix$"],
      "matchStrings": [
        "piholeVersion\\s*=\\s*\"(?<currentValue>[^\"]+?)\";"
      ],
      "depNameTemplate": "pihole/pihole",
      "datasourceTemplate": "docker"
    },
    {
      // Unbound image in constants.nix
      "customType": "regex",
      "fileMatch": ["^nix/common/constants\\.nix$"],
      "matchStrings": [
        "unboundImage\\s*=\\s*\"(?<depName>[^\"]+?):(?<currentValue>[^\"]+?)\";"
      ],
      "datasourceTemplate": "docker"
    }
  ],

  "packageRules": [
    // Group pre-commit hooks (minor + patch)
    {
      "groupName": "pre-commit hooks",
      "matchManagers": ["pre-commit"],
      "matchUpdateTypes": ["minor", "patch"]
    },

    // Group Terraform providers (minor + patch)
    {
      "groupName": "terraform providers",
      "matchManagers": ["terraform"],
      "matchUpdateTypes": ["minor", "patch"]
    },

    // Group arr-stack container images (minor + patch)
    {
      "groupName": "arr-stack containers",
      "matchFileNames": ["nix/arr-stack/arr.nix"],
      "matchUpdateTypes": ["minor", "patch"]
    },

    // Group Nix flake inputs (minor + patch)
    {
      "groupName": "nix flake inputs",
      "matchManagers": ["nix"],
      "matchUpdateTypes": ["minor", "patch"]
    },

    // Label major updates for careful review
    {
      "matchUpdateTypes": ["major"],
      "labels": ["dependencies", "major"]
    },

    // Disable digest pinning for custom regex-managed Nix files —
    // Nix string format ("image:tag") has no place for @sha256: digests
    {
      "matchManagers": ["custom.regex"],
      "pinDigests": false
    },

    // Ignore lidarr — uses non-standard pr-plugins-* versioning from hotio
    {
      "matchPackageNames": ["ghcr.io/hotio/lidarr"],
      "enabled": false
    },

  ]
}
