---
name: Build OSXPhotos Export Image

on:
  push:
    branches:
      - main
    paths:
      - "nix/osxphotos-export/**"
      - "nix/flake.nix"
      - "nix/flake.lock"
  workflow_call:
    inputs:
      version:
        description: "Semver tag to apply (e.g. osxphotos-export-v1.2.3)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build and Push OCI Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Build image
        run: nix build ./nix#osxphotos-export-image

      - name: Load and push image
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker load < result
          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          docker push ghcr.io/svnlto/osxphotos-export:latest

          SHA_TAG="ghcr.io/svnlto/osxphotos-export:${{ github.sha }}"
          docker tag ghcr.io/svnlto/osxphotos-export:latest "${SHA_TAG}"
          docker push "${SHA_TAG}"

          if [ -n "${{ inputs.version }}" ]; then
            # inputs.version is e.g. "osxphotos-export-v1.2.3", strip component prefix for semver
            SEMVER="${{ inputs.version }}"
            SEMVER="${SEMVER#osxphotos-export-}"
            docker tag ghcr.io/svnlto/osxphotos-export:latest "ghcr.io/svnlto/osxphotos-export:${SEMVER}"
            docker push "ghcr.io/svnlto/osxphotos-export:${SEMVER}"
          fi
