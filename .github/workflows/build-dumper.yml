---
name: Build Dumper Image

on:
  push:
    branches:
      - main
    paths:
      - "nix/dumper/**"
      - "nix/flake.nix"
      - "nix/flake.lock"
  workflow_call:
    inputs:
      version:
        description: "Semver tag to apply (e.g. dumper-v1.2.3)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    name: Build and Push OCI Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Build image
        run: nix build ./nix#dumper-image

      - name: Load and push image
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          docker load < result
          echo "${GITHUB_TOKEN}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          docker push ghcr.io/svnlto/dumper:latest

          SHA_TAG="ghcr.io/svnlto/dumper:${{ github.sha }}"
          docker tag ghcr.io/svnlto/dumper:latest "${SHA_TAG}"
          docker push "${SHA_TAG}"

          if [ -n "${{ inputs.version }}" ]; then
            # inputs.version is e.g. "dumper-v1.2.3", strip component prefix for semver
            SEMVER="${{ inputs.version }}"
            SEMVER="${SEMVER#dumper-}"
            docker tag ghcr.io/svnlto/dumper:latest "ghcr.io/svnlto/dumper:${SEMVER}"
            docker push "ghcr.io/svnlto/dumper:${SEMVER}"
          fi
