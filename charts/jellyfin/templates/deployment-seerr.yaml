---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seerr
  labels:
    {{- include "jellyfin.labels" (dict "name" "seerr") | nindent 4 }}
  annotations:
    {{- range $key, $val := .Values.global.annotations }}
    {{ $key }}: {{ $val | quote }}
    {{- end }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "jellyfin.selectorLabels" (dict "name" "seerr") | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "jellyfin.selectorLabels" (dict "name" "seerr") | nindent 8 }}
      annotations:
        {{- range $key, $val := .Values.global.annotations }}
        {{ $key }}: {{ $val | quote }}
        {{- end }}
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      initContainers:
        - name: chown-config
          image: busybox:1.37
          command: ["sh", "-c", "chown -R 1000:1000 /app/config"]
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: config
              mountPath: /app/config
      containers:
        - name: seerr
          image: {{ .Values.seerr.image }}
          ports:
            - containerPort: {{ .Values.seerr.port }}
              name: http
          env:
            - name: TZ
              value: {{ .Values.timezone }}
            {{- if .Values.seerr.database.host }}
            - name: DB_TYPE
              value: postgres
            - name: DB_HOST
              value: {{ .Values.seerr.database.host | quote }}
            - name: DB_PORT
              value: {{ .Values.seerr.database.port | default "5432" | quote }}
            - name: DB_USER
              value: {{ .Values.seerr.database.user | quote }}
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.seerr.database.passwordSecret.name }}
                  key: {{ .Values.seerr.database.passwordSecret.key }}
            - name: DB_NAME
              value: {{ .Values.seerr.database.name | quote }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /api/v1/status
              port: http
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/v1/status
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          resources:
            {{- toYaml .Values.seerr.resources | nindent 12 }}
          volumeMounts:
            - name: config
              mountPath: /app/config
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: seerr-config
