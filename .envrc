use flake

# 1Password CLI Integration
# Secrets are fetched from 1Password vault using `op` CLI
# Requires 1Password CLI: brew install 1password-cli
# See docs/1password-setup.md for setup guide

if command -v op >/dev/null 2>&1; then
  # Fetch secrets from 1Password
  # Note: Uses biometric auth (Touch ID) if configured

  # Proxmox API Token
  export PROXMOX_TOKEN_ID=$(op read "op://Homelab/Proxmox API Token/token_id" 2>/dev/null | sed 's/\\!/!/g' || echo "")
  export PROXMOX_TOKEN_SECRET=$(op read "op://Homelab/Proxmox API Token/token_secret" 2>/dev/null || echo "")

  # MikroTik Terraform API
  export MIKROTIK_USERNAME=$(op read "op://Homelab/MikroTik Terraform API/username" 2>/dev/null || echo "")
  export MIKROTIK_PASSWORD=$(op read "op://Homelab/MikroTik Terraform API/credential" 2>/dev/null || echo "")

  # Backblaze B2
  export B2_KEY_ID=$(op read "op://Homelab/Backblaze B2/key_id" 2>/dev/null || echo "")
  export B2_APPLICATION_KEY=$(op read "op://Homelab/Backblaze B2/application_key" 2>/dev/null || echo "")

  # OpenVPN credentials (for legacy services)
  export TF_VAR_openvpn_user=$(op read "op://Homelab/OpenVPN/username" 2>/dev/null || echo "")
  export TF_VAR_openvpn_password=$(op read "op://Homelab/OpenVPN/password" 2>/dev/null || echo "")

  # Soulseek credentials (for media automation)
  export TF_VAR_soulseek_username=$(op read "op://Homelab/Soulseek/username" 2>/dev/null || echo "")
  export TF_VAR_soulseek_password=$(op read "op://Homelab/Soulseek/password" 2>/dev/null || echo "")

  # TrueNAS SMB password (for Time Machine and file shares)
  export TRUENAS_SMB_PASSWORD=$(op read "op://Homelab/TrueNAS SMB User/password" 2>/dev/null || echo "")

  # ArgoCD admin password
  export TF_VAR_argocd_admin_password=$(op read "op://Homelab/ArgoCD Admin/password" 2>/dev/null || echo "")

  # TrueNAS API key for democratic-csi (Kubernetes)
  export TF_VAR_truenas_api_key=$(op read "op://Homelab/TrueNAS API Key/credential" 2>/dev/null || echo "")

  # Tailscale API key (for Terraform provider — ACL management)
  # OAuth client for K8s operator is created by the tailscale/acl Terraform module
  export TF_VAR_tailscale_api_key=$(op read "op://Homelab/Tailscale API Key/credential" 2>/dev/null || echo "")
  export TF_VAR_tailscale_tailnet=$(op read "op://Homelab/Tailscale API Key/tailnet" 2>/dev/null || echo "")

  # ClouDNS API (for Terraform provider and Traefik ACME)
  export TF_VAR_cloudns_auth_id=$(op read "op://Homelab/ClouDNS API/auth_id" 2>/dev/null || echo "")
  export TF_VAR_cloudns_auth_password=$(op read "op://Homelab/ClouDNS API/password" 2>/dev/null || echo "")

  # ACME email for Let's Encrypt
  export TF_VAR_acme_email=$(op read "op://Homelab/ACME Email/email" 2>/dev/null || echo "")

  # Check if any secrets failed to load
  if [ -z "$PROXMOX_TOKEN_ID" ] || [ -z "$PROXMOX_TOKEN_SECRET" ]; then
    echo "⚠️  Warning: Some 1Password secrets failed to load. Run 'eval \$(op signin)' to authenticate."
  fi
else
  echo "❌ 1Password CLI not found. Install with: brew install 1password-cli"
  echo "   See docs/1password-setup.md for setup instructions."
fi

# Export Terraform/Terragrunt variables
export TF_VAR_proxmox_api_token_id="$PROXMOX_TOKEN_ID"
export TF_VAR_proxmox_api_token_secret="$PROXMOX_TOKEN_SECRET"
export TF_VAR_mikrotik_username="$MIKROTIK_USERNAME"
export TF_VAR_mikrotik_password="$MIKROTIK_PASSWORD"

# Backblaze B2 for Terragrunt remote state (S3-compatible API)
export AWS_ACCESS_KEY_ID="${B2_KEY_ID:-}"
export AWS_SECRET_ACCESS_KEY="${B2_APPLICATION_KEY:-}"

# 1Password SSH Agent
export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

# 1Password Terraform provider (desktop app integration)
export OP_ACCOUNT="BMHATEENE5HVVJL3SYKCICPXNI"

# Claude Code bash settings
export CLAUDE_BASH_MAINTAIN_PROJECT_WORKING_DIR=1
export BASH_MAX_OUTPUT_LENGTH=10000
export BASH_DEFAULT_TIMEOUT_MS=300000

# MCP server credentials
# ArgoCD (add 1Password path when cluster is running)
export ARGOCD_API_TOKEN=$(op read "op://Homelab/ArgoCD API Token/credential" 2>/dev/null || echo "")
# GitHub token for Terragrunt docs MCP
export GITHUB_TOKEN=$(gh auth token 2>/dev/null || echo "")
