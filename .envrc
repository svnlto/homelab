use flake

# 1Password CLI Integration
# Secrets are fetched from 1Password vault using `op` CLI
# Falls back to .env file if 1Password CLI is not available
# See docs/1password-setup.md for migration guide

if command -v op >/dev/null 2>&1; then
  # Fetch secrets from 1Password
  # Note: Uses biometric auth (Touch ID) if configured

  # Proxmox API Token
  export PROXMOX_TOKEN_ID=$(op read "op://Personal/Proxmox API Token/token_id" 2>/dev/null || echo "")
  export PROXMOX_TOKEN_SECRET=$(op read "op://Personal/Proxmox API Token/token_secret" 2>/dev/null || echo "")

  # MikroTik Router
  export MIKROTIK_USERNAME=$(op read "op://Personal/MikroTik Router/username" 2>/dev/null || echo "")
  export MIKROTIK_PASSWORD=$(op read "op://Personal/MikroTik Router/password" 2>/dev/null || echo "")

  # Backblaze B2
  export B2_KEY_ID=$(op read "op://Personal/Backblaze B2/key_id" 2>/dev/null || echo "")
  export B2_APPLICATION_KEY=$(op read "op://Personal/Backblaze B2/application_key" 2>/dev/null || echo "")

  # OpenVPN credentials (for legacy services)
  export TF_VAR_openvpn_user=$(op read "op://Personal/OpenVPN/username" 2>/dev/null || echo "")
  export TF_VAR_openvpn_password=$(op read "op://Personal/OpenVPN/password" 2>/dev/null || echo "")

  # Soulseek credentials (for media automation)
  export TF_VAR_soulseek_username=$(op read "op://Personal/Soulseek/username" 2>/dev/null || echo "")
  export TF_VAR_soulseek_password=$(op read "op://Personal/Soulseek/password" 2>/dev/null || echo "")

  # Check if any secrets failed to load
  if [ -z "$PROXMOX_TOKEN_ID" ] || [ -z "$PROXMOX_TOKEN_SECRET" ]; then
    echo "⚠️  Warning: Some 1Password secrets failed to load, falling back to .env"
    dotenv_if_exists
  fi
else
  # Fallback to .env file if 1Password CLI not available
  echo "ℹ️  1Password CLI not found, using .env file"
  dotenv_if_exists
fi

# Export Terraform/Terragrunt variables
export TF_VAR_proxmox_api_token_id="$PROXMOX_TOKEN_ID"
export TF_VAR_proxmox_api_token_secret="$PROXMOX_TOKEN_SECRET"
export TF_VAR_mikrotik_username="$MIKROTIK_USERNAME"
export TF_VAR_mikrotik_password="$MIKROTIK_PASSWORD"

# Backblaze B2 for Terragrunt remote state (S3-compatible API)
export AWS_ACCESS_KEY_ID="${B2_KEY_ID:-}"
export AWS_SECRET_ACCESS_KEY="${B2_APPLICATION_KEY:-}"
