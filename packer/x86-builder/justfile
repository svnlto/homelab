# =============================================================================
# Justfile for x86 Builder (Bootable Disk Images)
# =============================================================================
#
# This build environment uses VMware Fusion to create an Ubuntu x86_64 VM with
# KVM/QEMU for building bootable x86_64 disk images (e.g., Proxmox nodes).
#
# =============================================================================

set dotenv-load := true

# Default recipe - show help
default:
    @just --list

# =============================================================================
# Vagrant VM Management
# =============================================================================

# Start the x86 build VM
vm-up:
    vagrant up

# Stop the x86 build VM
vm-down:
    vagrant halt

# Destroy the x86 build VM
vm-destroy:
    vagrant destroy -f

# SSH into the x86 build VM
vm-ssh:
    vagrant ssh

# Rebuild/reprovision the VM
vm-provision:
    vagrant provision

# Show VM status
vm-status:
    vagrant status

# =============================================================================
# Image Building
# =============================================================================

# Build x86_64 disk image (in Vagrant VM)
build: _ensure-vm
    #!/usr/bin/env bash
    set -euo pipefail
    echo "==> Syncing files to build VM..."
    vagrant rsync
    echo ""
    echo "==> Building x86_64 disk image..."
    echo "    This will take 20-40 minutes..."
    vagrant ssh -c "cd /vagrant && packer build ."
    echo ""
    echo "✅ Build complete!"
    just images

# Build with debug output
build-debug: _ensure-vm
    #!/usr/bin/env bash
    set -euo pipefail
    vagrant rsync
    echo "==> Building with PACKER_LOG=1..."
    vagrant ssh -c "cd /vagrant && PACKER_LOG=1 packer build ."
    just images

# Validate Packer template
validate: _ensure-vm
    vagrant ssh -c "cd /vagrant && packer validate ."

# Format Packer files
fmt:
    packer fmt .

# =============================================================================
# Deployment
# =============================================================================

# List available images
images:
    @echo "Available disk images:"
    @echo ""
    @ls -lh output/*.img output/*.raw 2>/dev/null || echo "  No images found. Run 'just build' first."

# Write image to disk (interactive, with confirmation)
deploy disk:
    #!/usr/bin/env bash
    set -euo pipefail

    IMAGE=$(ls -t output/*.{img,raw} 2>/dev/null | head -1)
    if [ -z "$IMAGE" ]; then
        echo "ERROR: No image found. Run 'just build' first."
        exit 1
    fi

    echo "┌────────────────────────────────────────────┐"
    echo "│  ⚠️  WARNING: DESTRUCTIVE OPERATION        │"
    echo "└────────────────────────────────────────────┘"
    echo ""
    echo "Image:  $IMAGE"
    echo "Target: {{disk}}"
    echo ""
    echo "This will ERASE ALL DATA on {{disk}}!"
    echo ""
    read -p "Type 'yes' to continue: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi

    echo ""
    echo "==> Writing image to {{disk}}..."
    sudo dd if="$IMAGE" of={{disk}} bs=4M status=progress conv=fdatasync
    sudo sync
    echo ""
    echo "✅ Done! Boot the target machine from {{disk}}"

# =============================================================================
# Cleanup
# =============================================================================

# Clean build outputs
clean:
    rm -rf output/*.img output/*.raw
    rm -rf .packer_cache

# Full clean (including VM)
clean-all: clean vm-destroy

# =============================================================================
# Info & Help
# =============================================================================

# Show environment info
info:
    @echo "x86 Builder for Bootable Disk Images"
    @echo "====================================="
    @echo ""
    @echo "Build VM:"
    @vagrant status 2>/dev/null | grep -E "^x86-builder" || echo "  not created"
    @echo ""
    @echo "Tools (in VM):"
    @echo "  qemu:   $(vagrant ssh -c 'qemu-system-x86_64 --version' 2>/dev/null | head -1 || echo 'VM not running')"
    @echo "  packer: $(vagrant ssh -c 'packer version' 2>/dev/null || echo 'VM not running')"
    @echo "  kvm:    $(vagrant ssh -c 'kvm-ok 2>&1' 2>/dev/null | head -1 || echo 'VM not running')"

# Show the complete workflow
workflow:
    @echo ""
    @echo "┌─────────────────────────────────────────────────────────────────┐"
    @echo "│         x86_64 Bootable Disk Image Build Workflow               │"
    @echo "└─────────────────────────────────────────────────────────────────┘"
    @echo ""
    @echo "  ┌──────────┐     ┌──────────┐     ┌──────────┐"
    @echo "  │  SETUP   │────▶│  BUILD   │────▶│  DEPLOY  │"
    @echo "  └──────────┘     └──────────┘     └──────────┘"
    @echo ""
    @echo "1. SETUP (one time):"
    @echo "   just vm-up          # Start VMware build VM"
    @echo ""
    @echo "2. BUILD (creates bootable disk image):"
    @echo "   just build          # Build disk image (20-40 min)"
    @echo ""
    @echo "3. DEPLOY (write to USB/SSD):"
    @echo "   diskutil list       # Find target disk (e.g., /dev/disk4)"
    @echo "   just deploy disk=/dev/rdisk4"
    @echo "   # Boot target machine from disk"
    @echo ""
    @echo "Use cases:"
    @echo "   • Bare-metal Proxmox node installation"
    @echo "   • Custom Linux bootable images"
    @echo "   • Automated OS deployments"
    @echo ""

# =============================================================================
# Internal Recipes
# =============================================================================

# Ensure VM is running
_ensure-vm:
    @vagrant status | grep -q "running" || (echo "==> Starting build VM..." && vagrant up)
