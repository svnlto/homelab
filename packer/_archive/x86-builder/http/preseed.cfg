# =============================================================================
# Debian 13 (Trixie) Preseed Configuration
# Minimal installation for Proxmox VE node
# =============================================================================

# -----------------------------------------------------------------------------
# Localization
# -----------------------------------------------------------------------------
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i console-setup/ask_detect boolean false
d-i console-setup/layoutcode string us

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
d-i netcfg/choose_interface select auto
d-i netcfg/link_wait_timeout string 10
d-i netcfg/dhcp_timeout string 60
d-i netcfg/dhcpv6_timeout string 60

# Hostname and domain are set via boot parameters
d-i netcfg/get_hostname string unassigned-hostname
d-i netcfg/get_domain string unassigned-domain

# Disable WEP key dialog
d-i netcfg/wireless_wep string

# -----------------------------------------------------------------------------
# Mirror Configuration
# -----------------------------------------------------------------------------
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i mirror/suite string trixie

# -----------------------------------------------------------------------------
# Account Setup
# -----------------------------------------------------------------------------
# Enable root login
d-i passwd/root-login boolean true
d-i passwd/make-user boolean false

# Root password (will be changed by Ansible)
d-i passwd/root-password password packer
d-i passwd/root-password-again password packer

# -----------------------------------------------------------------------------
# Clock and Timezone
# -----------------------------------------------------------------------------
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string pool.ntp.org

# -----------------------------------------------------------------------------
# Partitioning
# -----------------------------------------------------------------------------
# Use the first virtio disk
d-i partman-auto/disk string /dev/vda
d-i partman-auto/method string regular

# GPT partitioning for UEFI
d-i partman-partitioning/choose_label select gpt
d-i partman-partitioning/default_label string gpt
d-i partman-efi/non_efi_system boolean true

# Simple partition recipe:
# - 512MB EFI System Partition
# - Rest as root filesystem (ext4)
d-i partman-auto/expert_recipe string                         \
      boot-root ::                                            \
              512 512 512 fat32                               \
                      $primary{ }                             \
                      $iflabel{ gpt }                         \
                      $reusemethod{ }                         \
                      method{ efi }                           \
                      format{ }                               \
              .                                               \
              1024 10000 -1 ext4                              \
                      $primary{ }                             \
                      $bootable{ }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }   \
                      mountpoint{ / }                         \
              .

d-i partman-auto/choose_recipe select boot-root

# Confirm partitioning
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Don't use LVM
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Don't use RAID
d-i partman-md/device_remove_md boolean true
d-i partman-md/confirm boolean true

# -----------------------------------------------------------------------------
# Base System Installation
# -----------------------------------------------------------------------------
d-i base-installer/install-recommends boolean false
d-i base-installer/kernel/image string linux-image-amd64

# -----------------------------------------------------------------------------
# Apt Configuration
# -----------------------------------------------------------------------------
d-i apt-setup/non-free-firmware boolean true
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/use_mirror boolean true
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

# No CDROM in sources.list
d-i apt-setup/cdrom/set-first boolean false
d-i apt-setup/cdrom/set-next boolean false
d-i apt-setup/cdrom/set-failed boolean false

# -----------------------------------------------------------------------------
# Package Selection
# -----------------------------------------------------------------------------
tasksel tasksel/first multiselect standard, ssh-server

# Minimal package set - Ansible will install the rest
d-i pkgsel/include string \
    openssh-server \
    sudo \
    curl \
    wget \
    gnupg2 \
    apt-transport-https \
    ca-certificates \
    python3 \
    python3-apt \
    lsb-release \
    dmidecode \
    hdparm \
    lm-sensors

d-i pkgsel/upgrade select full-upgrade
d-i pkgsel/update-policy select none

# Disable popularity contest
popularity-contest popularity-contest/participate boolean false

# -----------------------------------------------------------------------------
# Boot Loader Installation
# -----------------------------------------------------------------------------
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean false
d-i grub-installer/bootdev string /dev/vda

# GRUB timeout
d-i grub-installer/timeout string 3

# -----------------------------------------------------------------------------
# Finishing Up
# -----------------------------------------------------------------------------
d-i finish-install/keep-consoles boolean true
d-i finish-install/reboot_in_progress note
d-i cdrom-detect/eject boolean true

# Avoid power off warning
d-i debian-installer/exit/poweroff boolean false

# -----------------------------------------------------------------------------
# Late Commands
# -----------------------------------------------------------------------------
d-i preseed/late_command string \
    in-target sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    in-target sed -i 's/PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    in-target sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config; \
    in-target systemctl enable ssh; \
    echo 'Defaults:root !requiretty' > /target/etc/sudoers.d/root-notty; \
    chmod 440 /target/etc/sudoers.d/root-notty
