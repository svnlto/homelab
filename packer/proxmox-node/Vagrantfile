# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# x86_64 Image Builder VM for Apple Silicon
# ==========================================
# Runs QEMU with TCG emulation for building x86_64 images.
# No KVM acceleration available on ARM host.

BUILD_VM_MEMORY = ENV.fetch('BUILD_VM_MEMORY', '8192')
BUILD_VM_CPUS = ENV.fetch('BUILD_VM_CPUS', '4')

Vagrant.configure("2") do |config|
  config.vm.define "x86-builder" do |builder|
    # Use Ubuntu 22.04 ARM64 (24.04 might not be available yet)
    builder.vm.box = "bento/ubuntu-22.04"
    builder.vm.hostname = "x86-builder"
    builder.vm.boot_timeout = 600

    # Network
    builder.vm.network "private_network", type: "dhcp"
    builder.vm.network "forwarded_port", guest: 5900, host: 5900, host_ip: "127.0.0.1"

    # SSH
    builder.ssh.insert_key = true
    builder.ssh.forward_agent = true

    # Sync packer directory
    builder.vm.synced_folder ".", "/vagrant",
      type: "rsync",
      rsync__auto: true,
      rsync__exclude: [
        '.git/',
        'output*/',
        'packer_cache/',
        '*.raw',
        '*.raw.gz',
        '*.qcow2',
        '*.img'
      ]

    # Sync ansible directory
    builder.vm.synced_folder "../../ansible", "/ansible",
      type: "rsync",
      rsync__exclude: ['.git/']

    # VMware Fusion provider
    builder.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = BUILD_VM_MEMORY
      v.vmx["numvcpus"] = BUILD_VM_CPUS
      v.gui = false

      # Enable nested virtualization (helps with performance)
      v.vmx["vhv.enable"] = "TRUE"
      v.vmx["vpmc.enable"] = "TRUE"
    end

    # Provision build environment
    builder.vm.provision "shell", name: "setup", inline: <<-SHELL
      set -euo pipefail

      export DEBIAN_FRONTEND=noninteractive

      echo "==> Installing QEMU and dependencies..."
      apt-get update
      apt-get install -y \
        qemu-system-x86 \
        qemu-utils \
        cloud-image-utils \
        genisoimage \
        curl \
        wget \
        unzip \
        jq \
        rsync \
        git \
        python3-pip \
        sshpass

      echo "==> Installing latest Ansible via pip..."
      pip3 install --upgrade ansible

      # Install Packer (match version from nix flake)
      PACKER_VERSION="1.14.3"
      if ! command -v packer &> /dev/null; then
        echo "==> Installing Packer ${PACKER_VERSION}..."
        ARCH=$(uname -m)
        if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
          PACKER_ARCH="arm64"
        else
          PACKER_ARCH="amd64"
        fi
        curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_${PACKER_ARCH}.zip" -o /tmp/packer.zip
        unzip -o /tmp/packer.zip -d /usr/local/bin/
        rm /tmp/packer.zip
      fi

      # Create output directory
      mkdir -p /vagrant/output
      chown vagrant:vagrant /vagrant/output

      # Initialize Packer plugins
      if ls /vagrant/*.pkr.hcl &> /dev/null; then
        echo "==> Initializing Packer plugins..."
        cd /vagrant && su -c "packer init ." vagrant || true
      fi

      echo ""
      echo "========================================"
      echo "x86 Build VM ready!"
      echo "========================================"
      echo ""
      echo "NOTE: Using TCG emulation (no KVM)."
      echo "Builds will be slower but functional."
      echo ""
      echo "Usage:"
      echo "  vagrant ssh"
      echo "  cd /vagrant && packer build ."
      echo ""
    SHELL
  end
end
