#cloud-config

# Root user configuration
users:
  - name: root
    lock_passwd: false

# Set root password for Packer SSH access
chpasswd:
  expire: false
  users:
    - name: root
      password: packer
      type: text

# Enable SSH password authentication
ssh_pwauth: true

# Don't disable root login
disable_root: false

# Explicit SSH server configuration
write_files:
  - path: /etc/ssh/sshd_config.d/99-packer.conf
    content: |
      PermitRootLogin yes
      PasswordAuthentication yes
      PubkeyAuthentication yes
    permissions: '0644'

# Grow root partition to fill disk
growpart:
  mode: auto
  devices: ['/']

# Resize filesystem
resize_rootfs: true

# Set timezone
timezone: UTC

# Minimal package update (Ansible will do the rest)
package_update: false
package_upgrade: false

# APT optimizations for faster package operations
apt:
  conf: |
    Acquire::Languages "none";
    APT::Install-Recommends "false";
    APT::Install-Suggests "false";

# Ensure SSH is running with correct configuration
runcmd:
  - systemctl enable ssh
  - systemctl restart ssh
